<!DOCTYPE html><!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="ru"> <![endif]--><!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang="ru"> <![endif]--><!--[if IE 8]>         <html class="no-js lt-ie9" lang="ru"> <![endif]--><!--[if gt IE 8]><!--> <html class="no-js" lang="ru"> <!--<![endif]--><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#"> <meta charset="utf-8">  <title>Блог джуниора. CRUD операции, Mongoose ODM | Блог Makeomatic: разработка сайтов и мобильных приложений</title> <meta name="author" content="Makeomatic">  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"> <!-- For third-generation iPad with high-resolution Retina display: --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144x144-precomposed.png"> <!-- For iPhone with high-resolution Retina display running iOS ≥ 7: --> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/apple-touch-icon-120x120-precomposed.png"> <!-- For iPhone with high-resolution Retina display running iOS ≤ 6: --> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png"> <!-- For first- and second-generation iPad: --> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png"> <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: --> <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"> <meta name="description" content="ЗадачиВ прошлый раз мы сделали небольшое приложение, которое позволяет регистрироваться пользователям. У близких к веб-программированиюлюдей все операции, описанные в предыдущем посте заняли бы минут">
<meta name="keywords" content="Для новичков,jQuery,Mongoose">
<meta property="og:type" content="article">
<meta property="og:title" content="Блог джуниора. CRUD операции, Mongoose ODM">
<meta property="og:url" content="https://makeomatic.ru/blog/2013/08/16/Deleting/index.html">
<meta property="og:site_name" content="Блог Makeomatic: разработка сайтов и мобильных приложений">
<meta property="og:description" content="ЗадачиВ прошлый раз мы сделали небольшое приложение, которое позволяет регистрироваться пользователям. У близких к веб-программированиюлюдей все операции, описанные в предыдущем посте заняли бы минут">
<meta property="og:updated_time" content="2016-01-08T17:55:51.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Блог джуниора. CRUD операции, Mongoose ODM">
<meta name="twitter:description" content="ЗадачиВ прошлый раз мы сделали небольшое приложение, которое позволяет регистрироваться пользователям. У близких к веб-программированиюлюдей все операции, описанные в предыдущем посте заняли бы минут">
<meta name="twitter:creator" content="@makeomatic">
<link rel="publisher" href="https://plus.google.com/+MakeomaticRu">   <link href='//fonts.googleapis.com/css?family=Roboto:300,700&subset=latin,cyrillic,cyrillic-ext' rel='stylesheet' type='text/css'>  <link rel="stylesheet" href="/css/app.min.2.3.1.css">  <script src="/js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script> <!-- place this in your head tag --> <!-- <script src='https://js.tito.io/v1' async></script> --> <!-- <link rel="stylesheet" type="text/css" href='https://css.tito.io/v1' /> --></head><body data-spy="scroll" data-target=".navbar" data-offset="150"><!--[if lt IE 8]><p class="chromeframe">Вы используете <strong>устаревший</strong> браузер. Пожалуйста <a href="http://browsehappy.com/">обновите ваш браузер</a> или <a href="http://www.google.com/chromeframe/?redirect=true">активируйте Google Chrome Frame</a>, чтобы улучшить ваши впечатления от посещения сайта.</p><![endif]--><header class="navbar navbar-inverse navbar-fixed-top"> <div class="navbar-inner"> <div class="container"> <div class="social-desktop"> <a class="fcb" href="https://www.facebook.com/makeomatic"> <i class="fa fa-facebook"></i> </a> <a class="vk" href="https://vk.com/makeomatic"> <i class="fa fa-vk"></i> </a> <a class="twt" href="https://twitter.com/MakeOmatic"> <i class="fa fa-twitter"></i> </a> <a class="gp" href="https://google.com/+MakeomaticRu"> <i class="fa fa-google-plus-square"></i> </a> </div> <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> <a class="brand" href="/">makeomatic</a> <div class="nav-collapse collapse"> <ul class="nav">   <li class='active '> <a href="/blog" > Блог  </a>  </li>   <li class=' dropdown'> <a href="/team" data-target="#" class="dropdown-toggle" data-toggle="dropdown"> Команда  <b class='caret'></b>  </a>  <ul class='dropdown-menu'>   <li> <a href="/team#vyacheslavgusev">Вячеслав Гусев</a> </li>   <li> <a href="/team#vitaliiaminev">Виталий Аминев</a> </li>   <li> <a href="/team#annaamineva">Анна Аминева</a> </li>   <li> <a href="/team#andreiafoninskii">Андрей Афонинский</a> </li>   <li> <a href="/team#aleksandrkremenets">Александр Кременец</a> </li>   <li> <a href="/team#dmitriigorbunov">Дмитрий Горбунов</a> </li>   <li> <a href="/team#evgeniipoyarkov">Евгений Поярков</a> </li>   <li> <a href="/team#ilyaovsyannikov">Илья Овсянников</a> </li>  </ul>  </li>   <li class=' '> <a href="/#about" > О нас  </a>  </li>   <li class=' dropdown'> <a href="/#portfolio" data-target="#" class="dropdown-toggle" data-toggle="dropdown"> Портфолио  <b class='caret'></b>  </a>  <ul class='dropdown-menu'>   <li> <a href="/#Distribut.io">Distribut.io</a> </li>   <li> <a href="/#Recordi">Recordi</a> </li>   <li> <a href="/#Photobot">Photobot</a> </li>   <li> <a href="/#BrainsApp">BrainsApp</a> </li>   <li> <a href="/#FabrikaTepla">FabrikaTepla</a> </li>   <li> <a href="/#SpeakGeo">SpeakGeo</a> </li>   <li> <a href="/#OpenInclude">OpenInclude</a> </li>   <li> <a href="/#LIVEONE">LIVEONE</a> </li>   <li> <a href="/#FitCafe">FitCafe</a> </li>  </ul>  </li>   <li class=' '> <a href="/#tech" > Технологии  </a>  </li>   <li class=' '> <a href="#contacts" > Контакты  </a>  </li>  </ul> </div><!--/.nav-collapse --> <div class='send-brief' > <a href='#brief' role='button' data-toggle='modal'> <i class='background'></i> <span>Заполнить бриф</span> </a> </div> <h4 class='phone-desktop'> Звоните: +7 (495) 79-222-44 </h4> </div> </div></header><div class="icon-up visible-desktop" id="up" title="наверх"></div><section class="container blog" id='blog'> <h1 class='outlined-caption text-center'> <a href='/blog'>Блог Makeomatic: разработка сайтов и мобильных приложений</a> </h1>  <div class='row'> <div class='span10'><article class="post"> <div class="post-content"> <header class='post-header'>   <h2 class="title">Блог джуниора. CRUD операции, Mongoose ODM</h2> <p class='muted'>небольшие инсайты и техники для SPA</p>   <div class="icon"></div> <time datetime="2013-08-16T07:00:00.000Z"> Aug 16 2013 </time>   <div class="tags"> | Категории: <a href="/blog/tags/Для-новичков/">Для новичков</a>, <a href="/blog/tags/jQuery/">jQuery</a>, <a href="/blog/tags/Mongoose/">Mongoose</a> </div> <span class='author'><img src='//www.gravatar.com/avatar/f03128c71396e710812f5d3c4de49149?s=20' /> Горшунов Владимир</span>  </header> <section class="body">  <h3 id="Задачи"><a href="#Задачи" class="headerlink" title="Задачи"></a>Задачи</h3><p>В прошлый раз мы сделали небольшое приложение, которое позволяет регистрироваться пользователям. У близких к веб-программированию<br>людей все операции, описанные в предыдущем посте заняли бы минут 15. Этот пост продолжает серию обучающих статей для джуниоров и будет<br>полезен лишь им.</p>
<p>Итак, задачи на сегодня:</p>
<ol>
<li>Добавить <code>API endpoint</code> для модели <code>User</code>, используя конвенцию <code>RESTful</code></li>
<li>Добавить суперюзера для работы в админке</li>
<li>Добавить админку</li>
<li>Добавить листинг зарегистрированных пользователей и возможность их удаления</li>
</ol>
<a id="more"></a>
<h3 id="Организация-API-endpoint"><a href="#Организация-API-endpoint" class="headerlink" title="Организация API-endpoint"></a>Организация API-endpoint</h3><p>Есть несколько технологий по созданию API используя <code>Mongoose</code>. Можно использовать готовые модули, но нам нужно разобраться как же это работает,<br>поэтому сделаем все с нули сами. <em>Здесь следует отметить, что можно просто дать прямой доступ ко всем API интерфейсу Mongoose, и в целом это неплохая методика,<br>которая позволит легче использовать один и тот же код на клиенте и на сервере, но об этом в других постах.</em><br>Итак, начнем мы с простого. Добавляем методы в <code>models/User.js</code> и настраиваем соответствующие руты:</p>
<figure class="highlight javascript"><figcaption><span>routes.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="comment">// у нас есть доступ к app, так код выполняется внутри соответствующей функции</span></div><div class="line"><span class="comment">// маунтим все запросы по /api/v.1/:model/: и добавляем обработчик</span></div><div class="line"><span class="comment">// саму функцию можно вынести в контроллеры, но пока этого не делаем, чтобы сохранить наглядность</span></div><div class="line">app.all(<span class="string">'/api/v.1/:model/*'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> method = req.method.toLowerCase(),</div><div class="line">        modelName  = req.params.model,</div><div class="line">        getParams = req.path.split(<span class="string">"/"</span>).splice(<span class="number">0</span>,<span class="number">4</span>); <span class="comment">// убираем 4 параметра, как нерелевантные для нас, остальное передаем</span></div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">var</span> model = <span class="built_in">require</span>(<span class="string">"./models/"</span>+modelName);</div><div class="line"></div><div class="line">        <span class="comment">// добавляем getParams</span></div><div class="line">        req.getParams = getParams;</div><div class="line">        model[method](req,res,next);</div><div class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">        <span class="comment">// если модуля или метода нет, то возвращаем ошибку</span></div><div class="line">        next(e);</div><div class="line">    &#125;</div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err,req,res,next</span>)</span>&#123;</div><div class="line">   <span class="comment">// здесь ловим ошибки</span></div><div class="line"></div><div class="line">   <span class="keyword">if</span> ( err ) &#123;</div><div class="line">        <span class="comment">// произошла ошибка - вернем ее, в дальнейшем лучше не возвращать ошибки пользователю напрямую</span></div><div class="line">        res.json(&#123;<span class="attr">error</span>: err&#125;, <span class="number">400</span>);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//  все хорошо, но пользователю решили ничего не отдавать</span></div><div class="line">        res.json(&#123;<span class="attr">success</span>: <span class="literal">true</span>&#125;);</div><div class="line">   &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><figcaption><span>models.User.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"></div><div class="line">User.statics.get = <span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// Следует отметить, что таким образом у всех пользователей есть доступ ко ВСЕМ</span></div><div class="line">    <span class="comment">// данным объекта, поэтому следует добавить разграничение доступа и/или убирать данные, которые не должны</span></div><div class="line">    <span class="comment">// быть доступны всем</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> id = req.getParams[<span class="number">0</span>];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ( id != <span class="literal">null</span> ) &#123;</div><div class="line">        <span class="keyword">this</span>.findById(id, <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">err, user</span>)</span>&#123;</div><div class="line">           <span class="comment">// если ошибка</span></div><div class="line">           <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);</div><div class="line">           <span class="keyword">if</span> (!user) <span class="keyword">return</span> res.send(<span class="number">404</span>);</div><div class="line"></div><div class="line">           <span class="comment">// <span class="doctag">TODO:</span> не безопасно, но пока сойдет</span></div><div class="line">           res.json(user);</div><div class="line">        &#125;);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">var</span> query = <span class="built_in">JSON</span>.parse(req.query.q || <span class="string">"&#123;&#125;"</span>),</div><div class="line">                options = <span class="built_in">JSON</span>.parse(req.query.o || <span class="string">"&#123;&#125;"</span>);</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.find(query, options, <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">err, users</span>)</span>&#123;</div><div class="line">                <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);</div><div class="line"></div><div class="line">                <span class="comment">// <span class="doctag">TODO:</span> не безопасно, но пока сойдет</span></div><div class="line">                res.json(users || []);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">            next(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line">User.statics.post = <span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> userData = req.body;</div><div class="line"></div><div class="line">    <span class="comment">// не делаем валидацию, этим займется Mongoose</span></div><div class="line">    <span class="comment">// в дальнейшем можно добавить кастомные проверки помимо валидации и уникальных индексов</span></div><div class="line">    <span class="keyword">this</span>.create(userData, <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">err, user</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);</div><div class="line">        res.json(user);</div><div class="line">    &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">User.statics.delete = <span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// здесь для примера добавлю проверку кто же есть наш пользователь</span></div><div class="line">    <span class="keyword">if</span> ( !req.session.user || req.session.user.isAdmin !== <span class="literal">true</span>) &#123;</div><div class="line">        <span class="keyword">return</span> res.send(<span class="number">403</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> id = req.getParams[<span class="number">0</span>];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ( id != <span class="literal">null</span> ) &#123;</div><div class="line">        <span class="keyword">this</span>.remove(id, <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">           <span class="comment">// если ошибка</span></div><div class="line">           <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);</div><div class="line">           res.send(<span class="number">200</span>);</div><div class="line">        &#125;);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">var</span> query = <span class="built_in">JSON</span>.parse(req.query.q || <span class="string">"&#123;&#125;"</span>);</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.remove(query, <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">                <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);</div><div class="line">                res.send(<span class="number">200</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">            next(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<p><br><br>По аналогии можно будет организовывать API и для других моделей</p>
<h3 id="Добавление-суперюзера-в-SPA"><a href="#Добавление-суперюзера-в-SPA" class="headerlink" title="Добавление суперюзера в SPA"></a>Добавление суперюзера в SPA</h3><p>Проделаем данную операцию при инициализации модели <code>User</code></p>
<figure class="highlight javascript"><figcaption><span>models/User.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"></div><div class="line">var model = mongoose.model(<span class="string">"User"</span>, User);</div><div class="line"><span class="keyword">var</span> superUser = &#123;</div><div class="line">    <span class="attr">username</span>: <span class="string">"root"</span>,</div><div class="line">    <span class="attr">password</span>: <span class="string">"&lt;заранее генерированный хеш&gt;"</span>,</div><div class="line">    <span class="attr">isAdmin</span>: <span class="literal">true</span></div><div class="line">&#125;;</div><div class="line"><span class="comment">// так как у нас есть уникальный индекс, то при рестарте приложения новый юзер не будет создаваться,</span></div><div class="line"><span class="comment">// а будет возвращаться ошибка - это не существенно</span></div><div class="line">model.create(superUser);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = model;</div></pre></td></tr></table></figure>
<h3 id="Админка"><a href="#Админка" class="headerlink" title="Админка"></a>Админка</h3><p>То, как сверстать шаблоны я описывать не буду - это достаточно простое занятие.<br>Мы добавим рут и соответствующий контроллер. Вход будет разрешен только супер-пользователю.<br>Он сможет просматривать список зарегистрированных пользователей и удалять их.</p>
<figure class="highlight javascript"><figcaption><span>middleware/session.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">exports.adminOnly = <span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span> (req.session.user &amp;&amp; req.session.user.isAdmin) <span class="keyword">return</span> next();</div><div class="line"></div><div class="line">  <span class="comment">// если доступа нет</span></div><div class="line">  res.send(<span class="string">"Нет доступа"</span>, <span class="number">403</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Модифицируем старую страницу, здесь есть пример того как ограничивать доступ к определенным частям приложений только администратору.<br>Нам следует добавить аналогичные ограничения в <code>GET</code>, <code>DELETE</code> запросы у модели <code>Users</code>.</p>
<figure class="highlight javascript"><figcaption><span>routes.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> sessionMiddleware = <span class="built_in">require</span>(<span class="string">"./middleware/session"</span>);</div><div class="line">...</div><div class="line"></div><div class="line">app.get(<span class="string">'/admin'</span>, sessionMiddleware.adminOnly, <span class="built_in">require</span>(<span class="string">"./controllers/admin"</span>).get);</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><figcaption><span>controllers/admin.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> User = <span class="built_in">require</span>(<span class="string">"../models/User.js"</span>);</div><div class="line"></div><div class="line">exports.get = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123; <span class="comment">//для возможности вызова  из другого файла</span></div><div class="line">    <span class="comment">// отдадим в страничку для рендера</span></div><div class="line">    <span class="keyword">var</span> context = &#123;&#125;;</div><div class="line"></div><div class="line">    <span class="comment">// получаем весь список сразу, если он будет большим, можно добавить лимит, инфинит</span></div><div class="line">    <span class="comment">// скроллинг, добавить стриминг (здорово экономит память - полезно, когда нужно обработать несколько тысяч объектов)</span></div><div class="line">    User.find(&#123;&#125;, <span class="function"><span class="keyword">function</span> <span class="title">userCallback</span>(<span class="params">err, users</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);</div><div class="line"></div><div class="line">        context.users = users;</div><div class="line"></div><div class="line">        <span class="comment">// очередная полезная функция express.js</span></div><div class="line">        <span class="comment">// передает контекст в template engine -- тут мы можем выбрать все что нашей душе угодно</span></div><div class="line">        <span class="comment">// я пропагандирую DoT.JS - лучшего решения пока не нашел</span></div><div class="line">        res.render(<span class="string">"&lt;шаблон для рендера&gt;"</span>, context);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>admin.dot</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- привожу только вырезку интересных моментов --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- не забываем подключить jquery, до фреймворков пока не доходит дело --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/path/to/jquery"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- partials пока не используем, лэйаутов базовых тоже нет --&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- выводим список юзеров --&gt;</span></div><div class="line">    <span class="comment">&lt;!-- использую одинарные &#123; &#125;, дабы статический генератор не пытался обработать их,</span></div><div class="line">         в реальности по умолчанию используются двойные фигурные скобки --&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">        &#123;~ it.users: user &#125;</div><div class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span></div><div class="line">            &#123;= user.username &#125;</div><div class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">data-id</span>=<span class="string">'&#123; = user._id &#125;'</span> <span class="attr">class</span>=<span class="string">'delete'</span>&gt;</span>[x]<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">        &#123;~&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">        $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">//Когда DOM готов</span></div><div class="line">          $(<span class="string">".delete"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123; <span class="comment">// отслеживаем ивент по нажатию на кнопку delete</span></div><div class="line">        	  <span class="keyword">var</span> $<span class="keyword">this</span> = $(<span class="keyword">this</span>); <span class="comment">// создаем ссылку на $this</span></div><div class="line">        	  $.ajax(&#123;</div><div class="line">        	     <span class="attr">url</span>: <span class="string">"/api/v.1/Users/"</span>+$<span class="keyword">this</span>.data(<span class="string">"id"</span>),</div><div class="line">        	     <span class="attr">type</span>: <span class="string">"DELETE"</span>,</div><div class="line">        	     <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;</div><div class="line">                    $<span class="keyword">this</span>.parent().remove();</div><div class="line">        	     &#125;,</div><div class="line">        	     <span class="attr">error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;</div><div class="line">        	        alert(<span class="string">"ошибка"</span>);</div><div class="line">        	     &#125;</div><div class="line">        	  &#125;);</div><div class="line">        	&#125;);</div><div class="line">        &#125;);</div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="Выводы"><a href="#Выводы" class="headerlink" title="Выводы"></a>Выводы</h3><p>На примере данных задач мы научились делать следующие вещи:</p>
<ol>
<li>Создавать <code>RESTful API</code></li>
<li>Разграничивать доступ к функционалу приложения</li>
<li>Вешать обработчики событий и отправлять запросы к серверу</li>
<li>Немного манипуляций с DOM</li>
</ol>
<p>Читайте так же статьи по теме: </p>
<ul>
<li><a href="https://makeomatic.ru/blog/2013/12/11/AngularJS_VS_jQuery/">Angular VS jQuery</a></li>
</ul>
  </section> <footer class='post-footer clearfix'>   <div class="addthis_toolbox addthis_default_style pull-right"> <a class="addthis_button_facebook"></a> <a class="addthis_button_twitter"></a> <a class="addthis_button_vk"></a> <a class="addthis_button_compact"></a> <a class="addthis_counter addthis_bubble_style"></a></div><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>  </footer> </div></article><section id="comment"> <h3 class="title">Комментарии</h3> <div id="disqus_thread"> <noscript>Включите Javascript, чтобы просмотреть <a href="//disqus.com/?ref_noscript">комментарии с помощью Disqus.</a></noscript> </div></section></div> <aside class="span2">  <div class="widget tag"> <h3 class="title">Тэги</h3> <ul class="unstyled">  <li> <span class='badge'>31</span> <a href="/blog/tags/AngularJS/"> AngularJS </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/CSS/"> CSS </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Chef/"> Chef </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Coffee-script/"> Coffee-script </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Cordova/"> Cordova </a> </li>  <li> <span class='badge'>5</span> <a href="/blog/tags/ElasticSearch/"> ElasticSearch </a> </li>  <li> <span class='badge'>5</span> <a href="/blog/tags/FAQ/"> FAQ </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/GitHub/"> GitHub </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/HTML5/"> HTML5 </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/ItProjects/"> ItProjects </a> </li>  <li> <span class='badge'>30</span> <a href="/blog/tags/Javascript/"> Javascript </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Mongoose/"> Mongoose </a> </li>  <li> <span class='badge'>11</span> <a href="/blog/tags/Node-js/"> Node.js </a> </li>  <li> <span class='badge'></span> <a href="/blog/tags/NodeJS/"> NodeJS </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Objective-C/"> Objective-C </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/PhoneGap/"> PhoneGap </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/RabbitMQ/"> RabbitMQ </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/SEO/"> SEO </a> </li>  <li> <span class='badge'>3</span> <a href="/blog/tags/SQL/"> SQL </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/YAC2014/"> YAC2014 </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/bash/"> bash </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/iOS7/"> iOS7 </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/jQuery/"> jQuery </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Бизнес-модель/"> Бизнес модель </a> </li>  <li> <span class='badge'>4</span> <a href="/blog/tags/Для-новичков/"> Для новичков </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Жизнь-компании/"> Жизнь компании </a> </li>  </ul></div></aside> </div></section> <!-- /container --><footer id='contacts' class='footer-main'> <div class='callback'> <div class='container'> <div class='row'> <div class='span12'> <h2 class='xlarge'>Есть вопросы или предложения?</h2> <p class='outlined-caption'>закажите обратный звонок и наш менеджер перезвонит вам</p> <form method='POST' action='/brief' id='callback'> <ul class='hidden error'></ul> <input type="text" name='name' placeholder="Как к вам обратиться?" class='span12' required /> <input type="text" name='phone' placeholder="По какому номеру звонить?" class='span6' /> <input type="email" name='email' placeholder="E-mail (опционально)" class='span6 pull-right' /> <textarea name='question' placeholder="Ваш вопрос (опционально)" class='span12'></textarea> <button type="submit" class='blue-plank'>Заказать звонок</button> </form> </div> </div> </div> </div> <div class='container'> <div class='row'> <div class='span6'> <h4 class='footer-caption'>Разделы сайта</h4> <ul class="nav inline">  <li><a href="/blog">Блог</a></li>  <li><a href="/team">Команда</a></li>  <li><a href="#about">О нас</a></li>  <li><a href="#portfolio">Портфолио</a></li>  <li><a href="#tech">Технологии</a></li>  <li><a href="#contacts">Контакты</a></li>  <li><a href='https://github.com/AVVSDevelopment/avvs.co'>Проект на GitHub</a></li> </ul> <p class='copyright'>Makeomatic, (c) 2012-2016<br/>Разработка сайтов и мобильных приложений</p> </div> <div class='span6 blue-line'> <h4 class='footer-caption'>Контакты</h4> <p> тел: +7 (495) 79-222-44 </p> <p> e-mail: <a href="mailto:getstarted@makeomatic.ru">getstarted@makeomatic.ru</a> </p> <address> Россия, Москва, Ленинский пр-т, дом 30а<br/>индекс: 111555 </address> <div class="social"> <a class="fcb fa-stack fa-lg" href="https://www.facebook.com/makeomatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i> </a> <a class="fa-stack fa-lg" href="http://vk.com/makeomatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-vk fa-stack-1x fa-inverse"></i> </a> <a class="twt fa-stack fa-lg" href="https://twitter.com/MakeOmatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </a> <a class="gp fa-stack fa-lg" href="https://google.com/+MakeomaticRu"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i> </a> </div> </div> </div> </div></footer><div class="modal hide fade brief" id='brief'> <div class="modal-body"> <div class='text-center'> <h2 class='brief-header outlined-caption'>Расскажите нам о вашем проекте</h2> <p class='small'> Коротко опишите ваши идеи или просто прикрепите файл с готовым ТЗ.<br/> Мы свяжемся с вами в течение 1 дня и подробно расскажем о том, как мы можем вам помочь. </p> </div> <form method='POST' action='/brief' class='callback'> <input type="text" name='name' placeholder="Как к вам обратиться?" class='span10' required /> <input type="text" name='phone' placeholder="По какому номеру звонить?" class='span5' /> <input type="email" name='email' placeholder="E-mail (опционально)" class='span5 pull-right' /> <textarea name='question' placeholder="Краткое описание вашего проекта" class='span7'></textarea> <div class='dropbox pull-right' id='dropbox' ></div> <button class="blue-plank pull-right" type='submit'>Отправить</button> </form> </div></div><!-- scripts --><script src="/js/app.min.2.3.1.js" charset="UTF-8" ></script><!-- end scripts --><script type="text/javascript">var disqus_shortname = 'makeomatic';(function(){ var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);}());</script><!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter15629977 = new Ya.Metrika({id:15629977, webvisor:true, clickmap:true, trackLinks:true, accurateTrackBounce:true, trackHash:true, ut:"noindex"}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/15629977?ut=noindex" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter --><!-- google analytics --><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-40638966-1', 'makeomatic.ru'); ga('send', 'pageview');</script></body></html>