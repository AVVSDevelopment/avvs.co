<!DOCTYPE html><!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="ru"> <![endif]--><!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang="ru"> <![endif]--><!--[if IE 8]>         <html class="no-js lt-ie9" lang="ru"> <![endif]--><!--[if gt IE 8]><!--> <html class="no-js" lang="ru"> <!--<![endif]--><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#"> <meta charset="utf-8">  <title>Улучшение логирования в AngularJS с помощью декораторов | Блог Makeomatic: разработка сайтов и мобильных приложений</title> <meta name="author" content="Makeomatic">  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"> <!-- For third-generation iPad with high-resolution Retina display: --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144x144-precomposed.png"> <!-- For iPhone with high-resolution Retina display running iOS ≥ 7: --> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/apple-touch-icon-120x120-precomposed.png"> <!-- For iPhone with high-resolution Retina display running iOS ≤ 6: --> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png"> <!-- For first- and second-generation iPad: --> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png"> <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: --> <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"> <meta name="description" content="Давайте выясним как использовать Декораторы (Decorators) для улучшения логирования в AngularJS и придания суперсил $log сервису. AngularJS имеет отличную скрытую возможность - $provider.decorator().">
<meta name="keywords" content="Javascript,AngularJS">
<meta property="og:type" content="article">
<meta property="og:title" content="Улучшение логирования в AngularJS с помощью декораторов">
<meta property="og:url" content="https://makeomatic.ru/blog/2014/01/06/AngulaJS_logging/index.html">
<meta property="og:site_name" content="Блог Makeomatic: разработка сайтов и мобильных приложений">
<meta property="og:description" content="Давайте выясним как использовать Декораторы (Decorators) для улучшения логирования в AngularJS и придания суперсил $log сервису. AngularJS имеет отличную скрытую возможность - $provider.decorator().">
<meta property="og:image" content="https://makeomatic.ru/blog/images/logging.jpg">
<meta property="og:updated_time" content="2016-01-08T17:55:51.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Улучшение логирования в AngularJS с помощью декораторов">
<meta name="twitter:description" content="Давайте выясним как использовать Декораторы (Decorators) для улучшения логирования в AngularJS и придания суперсил $log сервису. AngularJS имеет отличную скрытую возможность - $provider.decorator().">
<meta name="twitter:image" content="https://makeomatic.ru/blog/images/logging.jpg">
<meta name="twitter:creator" content="@makeomatic">
<link rel="publisher" href="https://plus.google.com/+MakeomaticRu">  <link rel="alternate" hreflang="ru" href="https:&#47;&#47;makeomatic.ru&#47;blog&#47;2014&#47;01&#47;06&#47;AngulaJS_logging&#47;" />   <meta property="og:image:width" content="441" /> <meta property="og:image:height" content="357" />  <link href='//fonts.googleapis.com/css?family=Roboto:300,700&subset=latin,cyrillic,cyrillic-ext' rel='stylesheet' type='text/css'>  <link rel="stylesheet" href="/css/app.min.2.3.1.css">  <script src="/js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script> <!-- place this in your head tag --> <!-- <script src='https://js.tito.io/v1' async></script> --> <!-- <link rel="stylesheet" type="text/css" href='https://css.tito.io/v1' /> --></head><body data-spy="scroll" data-target=".navbar" data-offset="150"><!--[if lt IE 8]><p class="chromeframe">Вы используете <strong>устаревший</strong> браузер. Пожалуйста <a href="http://browsehappy.com/">обновите ваш браузер</a> или <a href="http://www.google.com/chromeframe/?redirect=true">активируйте Google Chrome Frame</a>, чтобы улучшить ваши впечатления от посещения сайта.</p><![endif]--><header class="navbar navbar-inverse navbar-fixed-top"> <div class="navbar-inner"> <div class="container"> <div class="social-desktop"> <a class="fcb" href="https://www.facebook.com/makeomatic"> <i class="fa fa-facebook"></i> </a> <a class="vk" href="https://vk.com/makeomatic"> <i class="fa fa-vk"></i> </a> <a class="twt" href="https://twitter.com/MakeOmatic"> <i class="fa fa-twitter"></i> </a> <a class="gp" href="https://google.com/+MakeomaticRu"> <i class="fa fa-google-plus-square"></i> </a> </div> <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> <a class="brand" href="/">makeomatic</a> <div class="nav-collapse collapse"> <ul class="nav">   <li class='active '> <a href="/blog" > Блог  </a>  </li>   <li class=' dropdown'> <a href="/team" data-target="#" class="dropdown-toggle" data-toggle="dropdown"> Команда  <b class='caret'></b>  </a>  <ul class='dropdown-menu'>   <li> <a href="/team#vyacheslavgusev">Вячеслав Гусев</a> </li>   <li> <a href="/team#vitaliiaminev">Виталий Аминев</a> </li>   <li> <a href="/team#annaamineva">Анна Аминева</a> </li>   <li> <a href="/team#andreiafoninskii">Андрей Афонинский</a> </li>   <li> <a href="/team#aleksandrkremenets">Александр Кременец</a> </li>   <li> <a href="/team#dmitriigorbunov">Дмитрий Горбунов</a> </li>   <li> <a href="/team#evgeniipoyarkov">Евгений Поярков</a> </li>   <li> <a href="/team#ilyaovsyannikov">Илья Овсянников</a> </li>  </ul>  </li>   <li class=' '> <a href="/#about" > О нас  </a>  </li>   <li class=' dropdown'> <a href="/#portfolio" data-target="#" class="dropdown-toggle" data-toggle="dropdown"> Портфолио  <b class='caret'></b>  </a>  <ul class='dropdown-menu'>   <li> <a href="/#Distribut.io">Distribut.io</a> </li>   <li> <a href="/#Recordi">Recordi</a> </li>   <li> <a href="/#Photobot">Photobot</a> </li>   <li> <a href="/#BrainsApp">BrainsApp</a> </li>   <li> <a href="/#FabrikaTepla">FabrikaTepla</a> </li>   <li> <a href="/#SpeakGeo">SpeakGeo</a> </li>   <li> <a href="/#OpenInclude">OpenInclude</a> </li>   <li> <a href="/#LIVEONE">LIVEONE</a> </li>   <li> <a href="/#FitCafe">FitCafe</a> </li>  </ul>  </li>   <li class=' '> <a href="/#tech" > Технологии  </a>  </li>   <li class=' '> <a href="#contacts" > Контакты  </a>  </li>  </ul> </div><!--/.nav-collapse --> <div class='send-brief' > <a href='#brief' role='button' data-toggle='modal'> <i class='background'></i> <span>Заполнить бриф</span> </a> </div> <h4 class='phone-desktop'> Звоните: +7 (495) 79-222-44 </h4> </div> </div></header><div class="icon-up visible-desktop" id="up" title="наверх"></div><section class="container blog" id='blog'> <h1 class='outlined-caption text-center'> <a href='/blog'>Блог Makeomatic: разработка сайтов и мобильных приложений</a> </h1>  <div class='row'> <div class='span10'><article class="post"> <div class="post-content"> <header class='post-header'>   <h2 class="title">Улучшение логирования в AngularJS с помощью декораторов</h2> <p class='muted'></p>   <div class="icon"></div> <time datetime="2014-01-06T08:00:00.000Z"> Jan 6 2014 </time>   <div class="tags"> | Категории: <a href="/blog/tags/Javascript/">Javascript</a>, <a href="/blog/tags/AngularJS/">AngularJS</a> </div> <span class='author'><img src='//www.gravatar.com/avatar/20f85f2eff5b6d1983bc8b0d1cd37a42?s=20' /> Анна Аминева</span>  </header> <section class="body">  <p><img src="/blog/images/logging.jpg" alt="Иллюстрация блокнота"></p>
<p>Давайте выясним как использовать Декораторы (<code>Decorators</code>) для улучшения логирования в AngularJS и придания суперсил <code>$log</code> сервису. AngularJS имеет отличную скрытую возможность - <code>$provider.decorator()</code>. Она позволяет разработчикам перехватывать выполнение вызовов к сервисам и убирать, контролировать или изменять возможности этих сервисов. Возможность декорирования была спрятана не специально… скорее она затерялась среди других отличных возможностей AngularJS. В этой статье я представлю <code>Decorator</code> и покажу как постепенно добавлять функциональность к <code>$log</code> сервису… при этом практически не меняя созданные вами сервисы и контроллеры.</p>
<a id="more"></a>
<h2 id="Представляем-provide-decorator"><a href="#Представляем-provide-decorator" class="headerlink" title="Представляем $provide.decorator()"></a>Представляем $provide.decorator()</h2><p>Процесс перехвата происходит в тот момент, когда экземпляр сервиса уже создан и может быть использован на:</p>
<ul>
<li>AngularJS built-in services: $log, $animate, $http, etc.</li>
<li>Custom services: $twitter, $facebook, authenticator, etc.<br>In fact angular-mocks.js uses the decorator() to add</li>
<li>встроенных в AngularJS сервисах: <code>$log</code>, <code>$animate</code>, <code>$http</code>, и т.д.</li>
<li>собственных сервисах: <code>$twitter</code>, <code>$facebook</code>, <code>authenticator</code>, и т.д.</li>
</ul>
<p>Более того, <code>angular-mocks.js</code> использует <code>decorator()</code>, чтобы добавить:</p>
<ul>
<li><code>flush()</code> к <code>$timeout</code>,</li>
<li><code>respond()</code> к <code>$httpBackend</code>, и</li>
<li><code>flushNext()</code> к <code>$animate</code></li>
</ul>
<p>Так как мы добавляем или меняем поведение в момент построения сервиса, мне хотелось бы сказать, что <code>decorator()</code> позволяет нам внедрять собственные модели поведения. Итак, давайте выясним как вы можете использовать <code>decorator()</code> для улучшения AngularJS <code>$log</code> сервиса.<br>Перед тем как вы продолжите читать эту статью, я настоятельно рекомендую, чтобы вы сначала прочитали про внедрение зависимостей, используя обучения в RequireJS и AngularJS, потому что многие примеры используют RequireJS <code>define()</code> и внедрение зависимостей.</p>
<p>##Представляем AngularJS $log</p>
<p>AngularJS имеет встроенный сервис <code>$log</code>, который очень полезен для логирования сообщений об ошибках (как и дебаг информацию) в консоль. Используя этот сервис, разработчики могут просто контролировать процесс работы приложения, проверять правильность последовательности вызова функций и так далее. Более того, так как логирование используется очень часто, то разработчики постоянно недовольны, ведь им вечно требуется большее количество возможностей, чем дает стандартная консоль.<br>Я утверждаю, что разработчикам Ангуляра никогда не следует напрямую использовать <code>console.log()</code> для логирования сообщений в целях дебага. Вместо этого, пожалуйста, используйте <code>$log</code> …</p>
<p>Перед тем как говорить о расширении функционала, давайте сначала посмотрим на стандартное применение <code>$log</code>. Для наших целей, я буду использовать демо-приложение, которое показывает диалог для входа пользователю и предоставляет прототип сервиса авторизации. Внизу - скриншот демо-приложения.</p>
<p><img src="/blog/images/logging2.png" alt="Иллюстрация блокнота"></p>
<p>Вот и пример использования нормального (не улучшенного) <code>$log</code> сервиса внутри прототипа сервиса авторизации.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// *********************************************</span></div><div class="line"><span class="comment">// bootstrap.js</span></div><div class="line"><span class="comment">// *********************************************</span></div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line"><span class="meta">	"use strict"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Mock Authenticator with promise-returning API</div><div class="line">     */</div><div class="line">    <span class="keyword">var</span> Authenticator = <span class="function"><span class="keyword">function</span>(<span class="params"> session, $q, $log</span>)</span></div><div class="line">        &#123;</div><div class="line">                <span class="comment">/**</span></div><div class="line">                 * Mock login() service for authenticatator.</div><div class="line">                 * @returns &#123;Deferred.promise|*&#125;</div><div class="line">                 */</div><div class="line">            <span class="keyword">var</span> login = <span class="function"><span class="keyword">function</span>(<span class="params">username, password</span>)</span></div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">var</span> dfd      = $q.defer(),</div><div class="line">                        errorMsg = <span class="string">"Bad credentials. Please use a username of 'admin' for this mock login !"</span>;</div><div class="line"></div><div class="line">                    $log.debug( supplant(<span class="string">"login( `&#123;0&#125;` )"</span>, [username]) );</div><div class="line"></div><div class="line">                    <span class="keyword">if</span>( (username != <span class="string">"admin"</span>) &amp;&amp; (password != <span class="string">"secretPassword"</span>) )</div><div class="line">                    &#123;</div><div class="line">                        $log.debug( supplant( <span class="string">"login_onFault( `&#123;0&#125;` )"</span>, [errorMsg]) );</div><div class="line">                        dfd.reject( errorMsg );</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span></div><div class="line">                    &#123;</div><div class="line">                        $log.debug( supplant(<span class="string">"login_onResult(username = &#123;0&#125;, password = &#123;1&#125;)"</span>, [username, password]) );</div><div class="line"></div><div class="line">                        session.sessionID = <span class="string">"SESSION_83732"</span>;</div><div class="line">                        session.username = username;</div><div class="line"></div><div class="line">                        dfd.resolve(session);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">return</span> dfd.promise;</div><div class="line">                &#125;,</div><div class="line">                <span class="comment">/**</span></div><div class="line">                 * Mock service for logout.</div><div class="line">                 * @returns &#123;Deferred.promise|*&#125;</div><div class="line">                 */</div><div class="line">                logout = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">var</span> dfd = $q.defer();</div><div class="line"></div><div class="line">                    $log.debug(<span class="string">"logout()"</span>);</div><div class="line"></div><div class="line">                    session.sessionID = <span class="literal">null</span>;</div><div class="line">                    dfd.resolve();</div><div class="line"></div><div class="line">                    <span class="keyword">return</span> dfd.promise;</div><div class="line">                &#125;;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> &#123;</div><div class="line">                <span class="attr">login</span> : login,</div><div class="line">                <span class="attr">logout</span>: logout</div><div class="line">            &#125;;</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * LoginController used with the login template</div><div class="line">         */</div><div class="line">        LoginController = <span class="function"><span class="keyword">function</span>(<span class="params"> authenticator, $scope, $log </span>)</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> onLogin = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">            &#123;</div><div class="line">                $log.debug( supplant( <span class="string">"login( `&#123;userName&#125;` )"</span>, $scope ) );</div><div class="line"></div><div class="line">                authenticator</div><div class="line">                    .login( $scope.userName, $scope.password )</div><div class="line">                    .then(</div><div class="line">                    <span class="function"><span class="keyword">function</span> (<span class="params">result</span>)</span></div><div class="line">                    &#123;</div><div class="line">                        $log.debug( supplant( <span class="string">"login_onResult( `&#123;sessionID&#125;` )"</span>, result) );</div><div class="line"></div><div class="line">                        $scope.hasError = <span class="literal">false</span>;</div><div class="line">                        $scope.errorMessage = <span class="string">''</span>;</div><div class="line">                    &#125;,</div><div class="line">                    <span class="function"><span class="keyword">function</span> (<span class="params">fault</span>)</span></div><div class="line">                    &#123;</div><div class="line">                        $log.debug( supplant(<span class="string">"login_onFault( `&#123;0&#125;` )"</span>, [fault]) );</div><div class="line"></div><div class="line">                        $scope.hasError = <span class="literal">true</span>;</div><div class="line">                        $scope.errorMessage = fault;</div><div class="line">                    &#125;</div><div class="line">                );</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            $scope.login    = onLogin;</div><div class="line">            $scope.userName = <span class="string">''</span>;</div><div class="line">            $scope.password = <span class="string">''</span>;</div><div class="line"></div><div class="line">            $scope.hasError = <span class="literal">false</span>;</div><div class="line">            $scope.errorMessage = <span class="string">''</span>;</div><div class="line">        &#125;,</div><div class="line">        appName = <span class="string">"myApp.Application"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Start the main application</div><div class="line">     * We manually start this bootstrap process; since ng:app is gone</div><div class="line">     * ( necessary to allow Loader splash pre-AngularJS activity to finish properly )</div><div class="line">     */</div><div class="line"></div><div class="line">    angular.module(     appName,             [ ]             )</div><div class="line">           .value(      <span class="string">"session"</span>,           &#123; <span class="attr">sessionID</span> : <span class="literal">null</span> &#125;)</div><div class="line">           .factory(    <span class="string">"authenticator"</span>,     [<span class="string">"session"</span>, <span class="string">"$q"</span>, <span class="string">"$log"</span>, Authenticator]   )</div><div class="line">           .controller( <span class="string">"LoginController"</span>,   [ <span class="string">"authenticator"</span>, <span class="string">"$scope"</span>, <span class="string">"$log"</span>, LoginController ] );</div><div class="line"></div><div class="line">    angular.bootstrap( <span class="built_in">document</span>.getElementsByTagName(<span class="string">"body"</span>), [ appName ]);</div><div class="line"></div><div class="line">&#125;());</div></pre></td></tr></table></figure></p>
<p>Когда логин форма отправляется и <code>LoginController::login(&#39;Thomas Burleson&#39;, &#39;unknown&#39;)</code>вызван, <code>$log</code> выведет данные в консоль браузера:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">login( ‘Thomas Burleson’)<span class="string">`</span></div><div class="line">login( ‘Thomas Burleson’)`</div><div class="line">login_onFault( ‘Bad credentials. Please use a username <span class="keyword">of</span> ‘admin’ <span class="keyword">for</span> mock logins !’ )</div><div class="line">login_onFault( ‘Bad credentials. Please use a username <span class="keyword">of</span> ‘admin’ <span class="keyword">for</span> mock logins !’ )</div></pre></td></tr></table></figure></p>
<p>Вывод консоли показывает, что <code>LoginController</code> и <code>Authenticator</code> в данный момент корректно выводит данные в консоль</p>
<ul>
<li>Но вывод консоли вводит в замешательство!</li>
<li>Какой экземпляр класса вызова <code>$log.debug()</code>?</li>
</ul>
<p>Для решения этой проблемы мы можем модифицировать каждый вызов <code>$log.debug()</code>, чтобы вручную добавлять название класса и даже временной штамп к каждому из них; также временные марки позволят нам периодически проверять процесс исполнения кода.</p>
<p>Но НЕ делайте этого… Это решение для начинающих и оно чертовски убого. Вот пример вывода, который мы хотели бы увидеть:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">10:22:15:143 – LoginController::login( `Thomas Burleson` )</div><div class="line">10:22:15:167 – Authenticator::login( `Thomas Burleson` )</div><div class="line">10:22:15:250 – Authenticator::login_onFault( `Bad credentials. Please use a username of ‘admin’ for mock logins !` )</div><div class="line">10:22:15:274 – LoginController::login_onFault( `Bad credentials. Please use a username of ‘admin’ for mock logins !` )</div></pre></td></tr></table></figure></p>
<p>Перед тем как начать изменение ВСЕХ классов (так бы сделал начинающий разработчик), давайте остановимся и предположим, что <code>$provide.decorator()</code> позволит нам сделать это централизованно, и, более того, изменить или убрать любую функциональность. </p>
<p>##Используем $provider.decorator()</p>
<p>Давайте используем <code>$provider.decorator()</code> для перехвата вызовов к <code>$log.debug()</code> и динамически присоединим временные метки.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="meta">  "use strict"</span>;</div><div class="line"></div><div class="line">    angular</div><div class="line">      .module( appName, [ ] )</div><div class="line">      .config([ <span class="string">"$provide"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> $provide </span>)</span></div><div class="line">      &#123;</div><div class="line">            <span class="comment">// Use the `decorator` solution to substitute or attach behaviors to</span></div><div class="line">            <span class="comment">// original service instance; @see angular-mocks for more examples....</span></div><div class="line"></div><div class="line">            $provide.decorator( <span class="string">'$log'</span>, [ <span class="string">"$delegate"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> $delegate </span>)</span></div><div class="line">            &#123;</div><div class="line">                <span class="comment">// Save the original $log.debug()</span></div><div class="line">                <span class="keyword">var</span> debugFn = $delegate.debug;</div><div class="line"></div><div class="line">                $delegate.debug = <span class="function"><span class="keyword">function</span>(<span class="params"> </span>)</span></div><div class="line">                &#123;</div><div class="line">                  <span class="keyword">var</span> args    = [].slice.call(<span class="built_in">arguments</span>),</div><div class="line">                      now     = DateTime.formattedNow();</div><div class="line"></div><div class="line">                  <span class="comment">// Prepend timestamp</span></div><div class="line">                  args[<span class="number">0</span>] = supplant(<span class="string">"&#123;0&#125; - &#123;1&#125;"</span>, [ now, args[<span class="number">0</span>] ]);</div><div class="line"></div><div class="line">                  <span class="comment">// Call the original with the output prepended with formatted timestamp</span></div><div class="line">                  debugFn.apply(<span class="literal">null</span>, args)</div><div class="line">                &#125;;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> $delegate;</div><div class="line">            &#125;]);</div><div class="line">      &#125;]);</div><div class="line"></div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>В этом случае мы использовали head-hook перехватчик, чтобы присоединить строку к началу и  после вызвать исходную функцию.  Другие декораторы могут использовать tail-hook перехватчики или replace перехватчики. Разнообразие вариантов впечатляет. С вышеприведенными улучшениями вывод консоли покажет что-то похожее на:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">10:22:15:143 – login( `Thomas Burleson` )</div><div class="line">10:22:15:167 – login( `Thomas Burleson` )</div><div class="line">10:22:15:250 – login_onFault( `Bad credentials. Please use a username of ‘admin’ for mock logins !` )</div><div class="line">10:22:15:274 – login_onFault( `Bad credentials. Please use a username of ‘admin’ for mock logins !` )</div></pre></td></tr></table></figure></p>
<p>Но мы ведь еще хотели включить название класса для каждого вызванного метода!</p>
<ul>
<li>А вы заметили, что только <code>$log.debug()</code> был декорирован?</li>
<li>Как на счет декорирования  других функций, таких как <code>.error(), .warning()</code> и т.д.?<br>Достичь данного результата будет чуть сложнее… но не так сложно как вам может показаться!</li>
</ul>
<p>##Переработка для повторного использования кода</p>
<p>Перед тем, как мы расширим <code>LogEnhancer</code> еще большей функциональностью, давайте реорганизуем наш код. Мы переработаем его для того, чтобы мы смогли с легкостью повторно использовать его же в различных приложениях.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// **********************************</span></div><div class="line"><span class="comment">// Module: bootstrap.js</span></div><div class="line"><span class="comment">// **********************************</span></div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="meta">  "use strict"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> dependencies = [</div><div class="line">    <span class="string">'angular'</span>,</div><div class="line">    <span class="string">'myApp/logger/LogDecorator'</span>,</div><div class="line">    <span class="string">'myApp/services/Authenticator'</span>,</div><div class="line">    <span class="string">'myApp/controllers/LoginController'</span></div><div class="line">  ];</div><div class="line"></div><div class="line">  define( dependencies, <span class="function"><span class="keyword">function</span>(<span class="params"> angular, LogDecorator, Authenticator, LoginController </span>)</span></div><div class="line">  &#123;</div><div class="line">    <span class="comment">// Configure the AngularJS HTML5 application `myApp`</span></div><div class="line"></div><div class="line">    angular</div><div class="line">      .module(     <span class="string">"myApp"</span>,           [ ]              )</div><div class="line">      .config(     LogDecorator                        )</div><div class="line">      .service(    <span class="string">"authenticator"</span>,   Authenticator    )</div><div class="line">      .controller( <span class="string">"LoginController"</span>, LoginController  );</div><div class="line"></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;)();</div><div class="line"><span class="comment">// *****************************************</span></div><div class="line"><span class="comment">// Module: myApp/logger/LogDecorator.js</span></div><div class="line"><span class="comment">// *****************************************</span></div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line"><span class="meta">  "use strict"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> dependencies = [</div><div class="line">    <span class="string">'myApp/logger/LogEnhancer'</span></div><div class="line">  ];</div><div class="line"></div><div class="line">  define( dependencies, <span class="function"><span class="keyword">function</span>(<span class="params"> enchanceLoggerFn </span>)</span></div><div class="line">  &#123;</div><div class="line">      <span class="keyword">var</span> LogDecorator = <span class="function"><span class="keyword">function</span>(<span class="params"> $provide </span>)</span></div><div class="line">          &#123;</div><div class="line">              <span class="comment">// Register our $log decorator with AngularJS $provider</span></div><div class="line"></div><div class="line">              $provide.decorator( <span class="string">'$log'</span>, [ <span class="string">"$delegate"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> $delegate </span>)</span></div><div class="line">              &#123;</div><div class="line">                  <span class="comment">// <span class="doctag">NOTE:</span> the LogEnchancer module returns a FUNCTION that we named `enchanceLoggerFn`</span></div><div class="line">                  <span class="comment">//       All the details of how the `enchancement` works is encapsulated in LogEnhancer!</span></div><div class="line"></div><div class="line">                  enchanceLoggerFn( $delegate );</div><div class="line"></div><div class="line">                  <span class="keyword">return</span> $delegate;</div><div class="line">              &#125;]);</div><div class="line">          &#125;;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> [ <span class="string">"$provide"</span>, LogDecorator ];</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;)();</div><div class="line"><span class="comment">// ****************************************</span></div><div class="line"><span class="comment">// Module: myApp/logger/LogEnhancer.js</span></div><div class="line"><span class="comment">// ****************************************</span></div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line"><span class="meta">  "use strict"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> dependencies = [</div><div class="line">    <span class="string">'myApp/utils/DateTime'</span>,</div><div class="line">    <span class="string">'myApp/utils/supplant'</span></div><div class="line">  ];</div><div class="line"></div><div class="line">  define( dependencies, <span class="function"><span class="keyword">function</span>(<span class="params"> DateTime, supplant </span>)</span></div><div class="line">  &#123;</div><div class="line">    <span class="keyword">var</span> enchanceLogger = <span class="function"><span class="keyword">function</span>(<span class="params"> $log </span>)</span></div><div class="line">        &#123;</div><div class="line">          <span class="comment">// Save the original $log.debug()</span></div><div class="line">          <span class="keyword">var</span> debugFn = $log.debug;</div><div class="line"></div><div class="line">          $log.debug = <span class="function"><span class="keyword">function</span>(<span class="params"> </span>)</span></div><div class="line">          &#123;</div><div class="line">            <span class="keyword">var</span> args    = [].slice.call(<span class="built_in">arguments</span>),</div><div class="line">                now     = DateTime.formattedNow();</div><div class="line"></div><div class="line">                <span class="comment">// prepend a timestamp to the original output message</span></div><div class="line">                args[<span class="number">0</span>] = supplant(<span class="string">"&#123;0&#125; - &#123;1&#125;"</span>, [ now, args[<span class="number">0</span>] ]);</div><div class="line"></div><div class="line">            <span class="comment">// Call the original with the output prepended with formatted timestamp</span></div><div class="line">            debugFn.apply(<span class="literal">null</span>, args)</div><div class="line">          &#125;;</div><div class="line"></div><div class="line">          <span class="keyword">return</span> $log;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> enchanceLogger;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>Контейнерное структурирование, использованное выше, соответствует <a href="http://ru.wikipedia.org/wiki/%D0%97%D0%B0%D0%BA%D0%BE%D0%BD_%D0%94%D0%B5%D0%BC%D0%B5%D1%82%D1%80%D1%8B" target="_blank" rel="external">Закону Деметры</a>. При таком подходе весь функционал, которым сервис <code>$log</code> был улучшен, инкапсулируется в модуле <code>LogEnhancer</code>. </p>
<p>Вот теперь мы готовы продолжить добавление функционала в <code>LogEnhancer</code>… Мы будет внедрять имена классов и добавлять их в сообщения к выводу.</p>
<p>##Расширяем LogEnhancer</p>
<p>Чтобы с легкостью добавить к <code>$log</code> нужную функциональность, которая внедрит имена классов в вывод сообщений, нам нужно позволить <code>$log</code> генерировать уникальные экземпляры самого себя: где такой экземпляр будет зарегистрирован со специальным именем класса. </p>
<p>Возможно, пример кода вам это объяснит:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ****************************************</span></div><div class="line"><span class="comment">// Module: myApp/controllers/LoginController.js</span></div><div class="line"><span class="comment">// ****************************************</span></div><div class="line"></div><div class="line">define( dependencies, <span class="function"><span class="keyword">function</span>(<span class="params"> supplant </span>)</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">var</span> LoginController = <span class="function"><span class="keyword">function</span>(<span class="params"> authenticator, $scope, $log </span>)</span></div><div class="line">    &#123;</div><div class="line">        $log = $log.getInstance( <span class="string">"LoginController"</span> );</div><div class="line"></div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> [ <span class="string">"authenticator"</span>, <span class="string">"$scope"</span>, <span class="string">"$log"</span>, LoginController ];</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>Мы использовали метод <code>$log.getInstance()</code>, чтобы вернуть объект, который выглядит как <code>$log</code>, но на самом деле это НЕ AngularJS $log. Как мы это сделали?  Наш LogEnhancer декорировал AngularJS <code>$log</code> сервис и ДОБАВИЛ <code>getInstance()</code> метод к этому сервису.</p>
<p>Элегантность данного решения заключается в том, что <code>$log</code> до сих пор проходит <code>Duck</code> тест, но внутренне знает как  присоединять строку LoginController ко всем вызовам <code>$log</code>, выполненным в LoginController классе. Всего лишь одна строка кода добавит поддержку этого функционала в любой класс… и это здорово!</p>
<p>Давайте перечислим набор возможностей, которые нам до сих пор нужны, чтобы полностью заменить <code>$log</code> нашим модулем <code>LogEnhancer</code>:</p>
<ul>
<li>Перехват всех методов <code>$log</code>: log, info, warn, debug, error</li>
<li>Возможность построения вызова с токенизированными сообщениями и сложными параметрами (мы не будем обсуждать это в нашей статье)</li>
<li>Добавление  функции <code>getInstance()</code> с возможностью создавать отдельные экземпляры <code>$log</code> с определенными названиями классов</li>
</ul>
<p>##Использование каррирования внутри LogEnhancer</p>
<p>Мы можем использов��ть технику каррирования, чтобы захватить конкретную лог функцию, чтобы мы могли перехватывать только определенные вызовы к <code>log</code> функции. Эта техника позволяет нам использовать общий обработчик, который частично применяется к каждому вызову функции <code>$log</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// **********************************</span></div><div class="line"><span class="comment">// Module: myApp/logger/LogEnhancer.js</span></div><div class="line"><span class="comment">// **********************************</span></div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line"><span class="meta">  "use strict"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> dependencies = [</div><div class="line">    <span class="string">'myApp/utils/DateTime'</span></div><div class="line">    <span class="string">'myApp/utils/supplant'</span></div><div class="line">  ];</div><div class="line"></div><div class="line">  define( dependencies, <span class="function"><span class="keyword">function</span>(<span class="params"> DateTime, supplant </span>)</span></div><div class="line">  &#123;</div><div class="line">    <span class="keyword">var</span> enchanceLogger = <span class="function"><span class="keyword">function</span>(<span class="params"> $log </span>)</span></div><div class="line">        &#123;</div><div class="line">                <span class="comment">/**</span></div><div class="line">                 * Partial application to pre-capture a logger function</div><div class="line">                 */</div><div class="line">            <span class="keyword">var</span> prepareLogFn = <span class="function"><span class="keyword">function</span>(<span class="params"> logFn </span>)</span></div><div class="line">                &#123;</div><div class="line">                    <span class="comment">/**</span></div><div class="line">                     * Invoke the specified `logFn&lt;` with the supplant functionality...</div><div class="line">                     */</div><div class="line">                    <span class="keyword">var</span> enhancedLogFn = <span class="function"><span class="keyword">function</span> (<span class="params"> </span>)</span></div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>),</div><div class="line">                            now  = DateTime.formattedNow(),</div><div class="line"></div><div class="line">                            <span class="comment">// prepend a timestamp to the original output message</span></div><div class="line">                            args[<span class="number">0</span>] = supplant(<span class="string">"&#123;0&#125; - &#123;1&#125;"</span>, [ now, args[<span class="number">0</span>] ]);</div><div class="line"></div><div class="line">                        logFn.call( <span class="literal">null</span>,  supplant.apply( <span class="literal">null</span>, args ) );</div><div class="line">                    &#125;;</div><div class="line">                    </div><div class="line">                    <span class="comment">// Special... only needed to support angular-mocks expectations</span></div><div class="line">                    enhancedLogFn.logs = [ ];</div><div class="line"></div><div class="line">                    <span class="keyword">return</span> enhancedLogFn;</div><div class="line">                &#125;;</div><div class="line"></div><div class="line">            $log.log   = prepareLogFn( $log.log );</div><div class="line">            $log.info  = prepareLogFn( $log.info );</div><div class="line">            $log.warn  = prepareLogFn( $log.warn );</div><div class="line">            $log.debug = prepareLogFn( $log.debug );</div><div class="line">            $log.error = prepareLogFn( $log.error );</div><div class="line"></div><div class="line">            <span class="keyword">return</span> $log;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> enchanceLogger;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>Заметьте, что метод <code>debugFn.call( … )</code>, так же использует метод <code>supplant()</code>, чтобы преобразовать любой токенизированный контент в финальную строку для вывода:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> user = &#123; <span class="attr">who</span>:<span class="string">"Thomas Burleson"</span>, <span class="attr">email</span>:<span class="string">"ThomasBurleson@gmail.com"</span> &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// This should output:</span></div><div class="line">    <span class="comment">// A warning message for ‘Thomas Burleson’ will be sent to ‘ThomasBurleson@gmail.com’ !</span></div><div class="line"></div><div class="line">    $log.warn( <span class="string">"A warning message for ‘&#123;who&#125;’ will be sent to ‘&#123;email&#125;’ !"</span>, user );</div></pre></td></tr></table></figure>
<p>Итак, мы не только перехватили вызовы <code>$log</code> и добавили временные метки, но и улучшили эти функции, внедрив поддержку токенизированных строк.</p>
<p>##Добавляем <code>$log.getInstance()</code><br>Наконец нам надо реализовать метод <code>getInstance()</code> и опубликовать его как часть сервиса лог AngularJS.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// **********************************</span></div><div class="line"><span class="comment">// Module: myApp/logger/LogEnhancer.js</span></div><div class="line"><span class="comment">// **********************************</span></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line"><span class="meta">  "use strict"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> dependencies = [</div><div class="line">            <span class="string">'myApp/utils/DateTime'</span>,</div><div class="line">            <span class="string">'myApp/utils/supplant'</span></div><div class="line">      ];</div><div class="line"></div><div class="line">  define( dependencies, <span class="function"><span class="keyword">function</span>(<span class="params"> DateTime, supplant </span>)</span></div><div class="line">  &#123;</div><div class="line">    <span class="keyword">var</span> enhanceLogger = <span class="function"><span class="keyword">function</span>(<span class="params"> $log </span>)</span></div><div class="line">        &#123;</div><div class="line">                <span class="comment">/**</span></div><div class="line">                 * Capture the original $log functions; for use in enhancedLogFn()</div><div class="line">                 */</div><div class="line">            <span class="keyword">var</span> _$log = (<span class="function"><span class="keyword">function</span>(<span class="params"> $log </span>)</span></div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">return</span> &#123;</div><div class="line">                        <span class="attr">log</span>   : $log.log,</div><div class="line">                        <span class="attr">info</span>  : $log.info,</div><div class="line">                        <span class="attr">warn</span>  : $log.warn,</div><div class="line">                        <span class="attr">debug</span> : $log.debug,</div><div class="line">                        <span class="attr">error</span> : $log.error</div><div class="line">                    &#125;;</div><div class="line">                &#125;)( $log ),</div><div class="line">                <span class="comment">/**</span></div><div class="line">                 * Partial application to pre-capture a logger function</div><div class="line">                 */</div><div class="line">                prepareLogFn = <span class="function"><span class="keyword">function</span>(<span class="params"> logFn, className </span>)</span></div><div class="line">                &#123;</div><div class="line">                    <span class="comment">/**</span></div><div class="line">                     * Invoke the specified `logFn` with the supplant functionality...</div><div class="line">                     */</div><div class="line">                    <span class="keyword">var</span> enhancedLogFn = <span class="function"><span class="keyword">function</span> (<span class="params"> </span>)</span></div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>),</div><div class="line">                            now  = DateTime.formattedNow();</div><div class="line"></div><div class="line">                            <span class="comment">// prepend a timestamp and optional classname to the original output message</span></div><div class="line">                            args[<span class="number">0</span>] = supplant(<span class="string">"&#123;0&#125; - &#123;1&#125;&#123;2&#125;"</span>, [ now, className, args[<span class="number">0</span>] ]);</div><div class="line"></div><div class="line">                        logFn.call( <span class="literal">null</span>,  supplant.apply( <span class="literal">null</span>, args ) );</div><div class="line">                    &#125;;</div><div class="line"></div><div class="line">                    <span class="comment">// Special... only needed to support angular-mocks expectations</span></div><div class="line">                    enhancedLogFn.logs = [ ];</div><div class="line"></div><div class="line">                    <span class="keyword">return</span> enhancedLogFn;</div><div class="line">                &#125;,</div><div class="line">                <span class="comment">/**</span></div><div class="line">                 * Support to generate class-specific logger instance with classname only</div><div class="line">                 *</div><div class="line">                 * @param name</div><div class="line">                 * @returns Object wrapper facade to $log</div><div class="line">                 */</div><div class="line">                getInstance = <span class="function"><span class="keyword">function</span>(<span class="params"> className </span>)</span></div><div class="line">                &#123;</div><div class="line">                    className = ( className !== <span class="literal">undefined</span> ) ? className + <span class="string">"::"</span> : <span class="string">""</span>;</div><div class="line"></div><div class="line">                    <span class="keyword">return</span> &#123;</div><div class="line">                        <span class="attr">log</span>   : prepareLogFn( _$log.log,    className ),</div><div class="line">                        <span class="attr">info</span>  : prepareLogFn( _$log.info,   className ),</div><div class="line">                        <span class="attr">warn</span>  : prepareLogFn( _$log.warn,   className ),</div><div class="line">                        <span class="attr">debug</span> : prepareLogFn( _$log.debug,  className ),</div><div class="line">                        <span class="attr">error</span> : prepareLogFn( _$log.error,  className )</div><div class="line">                    &#125;;</div><div class="line">                &#125;;</div><div class="line"></div><div class="line">            $log.log   = prepareLogFn( $log.log );</div><div class="line">            $log.info  = prepareLogFn( $log.info );</div><div class="line">            $log.warn  = prepareLogFn( $log.warn );</div><div class="line">            $log.debug = prepareLogFn( $log.debug );</div><div class="line">            $log.error = prepareLogFn( $log.error );</div><div class="line"></div><div class="line">            <span class="comment">// Add special method to AngularJS $log</span></div><div class="line">            $log.getInstance = getInstance;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> $log;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> enhanceLogger;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>Мы преобразовываем нашу функцию <code>prepareLogFn()</code>, используемую для каррирования, чтобы принять опциональный аргумент с названием класса. И мы создали метод <code>getInstance()</code>, который создает экземпляр объекта с тем же API, что и у оригинального лог сервиса.<br>Наконец, нам нужно преобразовать наш оригинальный пример кода с использованием <code>$log.getInstance()</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line"><span class="meta">	"use strict"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> dependencies = [</div><div class="line">		<span class="string">'myApp/utils/supplant'</span></div><div class="line">	];</div><div class="line"></div><div class="line">	define( dependencies, <span class="function"><span class="keyword">function</span>(<span class="params"> supplant </span>)</span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">var</span> Authenticator = <span class="function"><span class="keyword">function</span>(<span class="params"> session, $q, $log</span>)</span></div><div class="line">		&#123;</div><div class="line">		    $log = $log.getInstance( <span class="string">"Authenticator"</span> );</div><div class="line"></div><div class="line">		    <span class="comment">// … other code here</span></div><div class="line">		&#125;;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> [<span class="string">"session"</span>, <span class="string">"$q"</span>, <span class="string">"$log"</span>, Authenticator];</div><div class="line"></div><div class="line">	&#125;);</div><div class="line"></div><div class="line">	define( dependencies, <span class="function"><span class="keyword">function</span>(<span class="params"> supplant </span>)</span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">var</span> LoginController = <span class="function"><span class="keyword">function</span>(<span class="params"> authenticator, $scope, $log </span>)</span></div><div class="line">		    &#123;</div><div class="line">			$log = $log.getInstance( <span class="string">"LoginController"</span> );</div><div class="line"></div><div class="line">			<span class="keyword">var</span> onLogin = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">			    &#123;</div><div class="line">			        $log.debug( <span class="string">"login( `&#123;userName&#125;` )"</span>, $scope );</div><div class="line"></div><div class="line">			        <span class="comment">// … other code here</span></div><div class="line">			    &#125;;</div><div class="line"></div><div class="line">			    <span class="comment">// … other code here</span></div><div class="line">		    &#125;;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> [ <span class="string">"authenticator"</span>, <span class="string">"$scope"</span>, <span class="string">"$log"</span>, LoginController ];</div><div class="line"></div><div class="line">	&#125;);</div><div class="line"></div><div class="line">&#125;());</div></pre></td></tr></table></figure>
<p>Вы заметили дополнительное изменение, показанное в 30 строке исходного кода выше? <code>$log.debug()</code> включил все возможности <code>supplant()</code> в LogEnhancer… Так, что теперь вызовы к <code>$log</code> поддерживают токенизированные строки и ассоциативные массивы.</p>
<p>Теперь вывод в браузерную консоль будет таким:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">10:22:15:143 – LoginController::login( `Thomas Burleson` )</div><div class="line">10:22:15:167 – Authenticator::login( `Thomas Burleson` )</div><div class="line">10:22:15:250 – Authenticator::login_onFault( `Bad credentials. Please use a username of ‘admin’ for mock logins !` )</div><div class="line">10:22:15:274 – LoginController::login_onFault( `Bad credentials. Please use a username of ‘admin’ for mock logins !` )</div></pre></td></tr></table></figure></p>
<p>ВЫВОДЫ<br>Это  только один пример того, как Декораторы могут быть использованы для добавления или преобразования поведения в AngularJS приложениях. А LogEnhancer может быть также расширен с возможностями:</p>
<ul>
<li>Вывод  в кастомную консоль приложения… например, для генерации удаленных отчетов для клиентов</li>
<li>Цветовое кодирование и группирование сообщений в логе по категориям; @see Chrome Dev Tools</li>
<li>Логирование клиентских ошибок на удаленный сервер</li>
</ul>
<p>Я уверен, что с помощью данной техники можно создать еще множество элегантных решений. Если у вас есть классный декоратор, не забудьте поделиться им с AngularJS сообществом!</p>
<p>МАТЕРИАЛЫ<br>Я создал публичный GitHub репозиторий с исходным кодом и примерами, использованными в данном материале.<br>По мотивам <a href="http://solutionoptimist.com/2013/10/07/enhance-angularjs-logging-using-decorators/" target="_blank" rel="external">Burleson Thomas</a></p>
  </section> <footer class='post-footer clearfix'>   <div class="addthis_toolbox addthis_default_style pull-right"> <a class="addthis_button_facebook"></a> <a class="addthis_button_twitter"></a> <a class="addthis_button_vk"></a> <a class="addthis_button_compact"></a> <a class="addthis_counter addthis_bubble_style"></a></div><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>  </footer> </div></article><section id="comment"> <h3 class="title">Комментарии</h3> <div id="disqus_thread"> <noscript>Включите Javascript, чтобы просмотреть <a href="//disqus.com/?ref_noscript">комментарии с помощью Disqus.</a></noscript> </div></section></div> <aside class="span2">  <div class="widget tag"> <h3 class="title">Тэги</h3> <ul class="unstyled">  <li> <span class='badge'>31</span> <a href="/blog/tags/AngularJS/"> AngularJS </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/CSS/"> CSS </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Chef/"> Chef </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Coffee-script/"> Coffee-script </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Cordova/"> Cordova </a> </li>  <li> <span class='badge'>5</span> <a href="/blog/tags/ElasticSearch/"> ElasticSearch </a> </li>  <li> <span class='badge'>5</span> <a href="/blog/tags/FAQ/"> FAQ </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/GitHub/"> GitHub </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/HTML5/"> HTML5 </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/ItProjects/"> ItProjects </a> </li>  <li> <span class='badge'>30</span> <a href="/blog/tags/Javascript/"> Javascript </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Mongoose/"> Mongoose </a> </li>  <li> <span class='badge'>11</span> <a href="/blog/tags/Node-js/"> Node.js </a> </li>  <li> <span class='badge'></span> <a href="/blog/tags/NodeJS/"> NodeJS </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Objective-C/"> Objective-C </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/PhoneGap/"> PhoneGap </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/RabbitMQ/"> RabbitMQ </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/SEO/"> SEO </a> </li>  <li> <span class='badge'>3</span> <a href="/blog/tags/SQL/"> SQL </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/YAC2014/"> YAC2014 </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/bash/"> bash </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/iOS7/"> iOS7 </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/jQuery/"> jQuery </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Бизнес-модель/"> Бизнес модель </a> </li>  <li> <span class='badge'>4</span> <a href="/blog/tags/Для-новичков/"> Для новичков </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Жизнь-компании/"> Жизнь компании </a> </li>  </ul></div></aside> </div></section> <!-- /container --><footer id='contacts' class='footer-main'> <div class='callback'> <div class='container'> <div class='row'> <div class='span12'> <h2 class='xlarge'>Есть вопросы или предложения?</h2> <p class='outlined-caption'>закажите обратный звонок и наш менеджер перезвонит вам</p> <form method='POST' action='/brief' id='callback'> <ul class='hidden error'></ul> <input type="text" name='name' placeholder="Как к вам обратиться?" class='span12' required /> <input type="text" name='phone' placeholder="По какому номеру звонить?" class='span6' /> <input type="email" name='email' placeholder="E-mail (опционально)" class='span6 pull-right' /> <textarea name='question' placeholder="Ваш вопрос (опционально)" class='span12'></textarea> <button type="submit" class='blue-plank'>Заказать звонок</button> </form> </div> </div> </div> </div> <div class='container'> <div class='row'> <div class='span6'> <h4 class='footer-caption'>Разделы сайта</h4> <ul class="nav inline">  <li><a href="/blog">Блог</a></li>  <li><a href="/team">Команда</a></li>  <li><a href="#about">О нас</a></li>  <li><a href="#portfolio">Портфолио</a></li>  <li><a href="#tech">Технологии</a></li>  <li><a href="#contacts">Контакты</a></li>  <li><a href='https://github.com/AVVSDevelopment/avvs.co'>Проект на GitHub</a></li> </ul> <p class='copyright'>Makeomatic, (c) 2012-2016<br/>Разработка сайтов и мобильных приложений</p> </div> <div class='span6 blue-line'> <h4 class='footer-caption'>Контакты</h4> <p> тел: +7 (495) 79-222-44 </p> <p> e-mail: <a href="mailto:getstarted@makeomatic.ru">getstarted@makeomatic.ru</a> </p> <address> Россия, Москва, Ленинский пр-т, дом 30а<br/>индекс: 111555 </address> <div class="social"> <a class="fcb fa-stack fa-lg" href="https://www.facebook.com/makeomatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i> </a> <a class="fa-stack fa-lg" href="http://vk.com/makeomatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-vk fa-stack-1x fa-inverse"></i> </a> <a class="twt fa-stack fa-lg" href="https://twitter.com/MakeOmatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </a> <a class="gp fa-stack fa-lg" href="https://google.com/+MakeomaticRu"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i> </a> </div> </div> </div> </div></footer><div class="modal hide fade brief" id='brief'> <div class="modal-body"> <div class='text-center'> <h2 class='brief-header outlined-caption'>Расскажите нам о вашем проекте</h2> <p class='small'> Коротко опишите ваши идеи или просто прикрепите файл с готовым ТЗ.<br/> Мы свяжемся с вами в течение 1 дня и подробно расскажем о том, как мы можем вам помочь. </p> </div> <form method='POST' action='/brief' class='callback'> <input type="text" name='name' placeholder="Как к вам обратиться?" class='span10' required /> <input type="text" name='phone' placeholder="По какому номеру звонить?" class='span5' /> <input type="email" name='email' placeholder="E-mail (опционально)" class='span5 pull-right' /> <textarea name='question' placeholder="Краткое описание вашего проекта" class='span7'></textarea> <div class='dropbox pull-right' id='dropbox' ></div> <button class="blue-plank pull-right" type='submit'>Отправить</button> </form> </div></div><!-- scripts --><script src="/js/app.min.2.3.1.js" charset="UTF-8" ></script><!-- end scripts --><script type="text/javascript">var disqus_shortname = 'makeomatic';(function(){ var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);}());</script><!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter15629977 = new Ya.Metrika({id:15629977, webvisor:true, clickmap:true, trackLinks:true, accurateTrackBounce:true, trackHash:true, ut:"noindex"}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/15629977?ut=noindex" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter --><!-- google analytics --><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-40638966-1', 'makeomatic.ru'); ga('send', 'pageview');</script></body></html>