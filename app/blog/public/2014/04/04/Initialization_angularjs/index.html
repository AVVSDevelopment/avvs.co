<!DOCTYPE html><!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="ru"> <![endif]--><!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang="ru"> <![endif]--><!--[if IE 8]>         <html class="no-js lt-ie9" lang="ru"> <![endif]--><!--[if gt IE 8]><!--> <html class="no-js" lang="ru"> <!--<![endif]--><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#"> <meta charset="utf-8">  <title>Последовательная асинхронная инициализация Angular.JS приложений с использованием промисов | Блог Makeomatic: разработка сайтов и мобильных приложений</title> <meta name="author" content="Makeomatic">  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"> <!-- For third-generation iPad with high-resolution Retina display: --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144x144-precomposed.png"> <!-- For iPhone with high-resolution Retina display running iOS ≥ 7: --> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/apple-touch-icon-120x120-precomposed.png"> <!-- For iPhone with high-resolution Retina display running iOS ≤ 6: --> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png"> <!-- For first- and second-generation iPad: --> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png"> <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: --> <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"> <meta name="description" content="AngularJS помогает загружать ваше приложение путем внедрения зависимостей, основываясь на упорядоченном создании экземпляров классов. Тем не менее, иногда вам нужно знать завершился ли один из текущих">
<meta property="og:type" content="article">
<meta property="og:title" content="Последовательная асинхронная инициализация Angular.JS приложений с использованием промисов">
<meta property="og:url" content="https://makeomatic.ru/blog/2014/04/04/Initialization_angularjs/index.html">
<meta property="og:site_name" content="Блог Makeomatic: разработка сайтов и мобильных приложений">
<meta property="og:description" content="AngularJS помогает загружать ваше приложение путем внедрения зависимостей, основываясь на упорядоченном создании экземпляров классов. Тем не менее, иногда вам нужно знать завершился ли один из текущих">
<meta property="og:image" content="https://makeomatic.ru/blog/images/Initialization.jpg">
<meta property="og:updated_time" content="2015-01-16T20:34:23.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Последовательная асинхронная инициализация Angular.JS приложений с использованием промисов">
<meta name="twitter:description" content="AngularJS помогает загружать ваше приложение путем внедрения зависимостей, основываясь на упорядоченном создании экземпляров классов. Тем не менее, иногда вам нужно знать завершился ли один из текущих">
<meta name="twitter:creator" content="@makeomatic">
<link rel="publisher" href="https://plus.google.com/+MakeomaticRu">  <link rel="alternate" hreflang="ru" href="https:&#47;&#47;makeomatic.ru&#47;blog&#47;2014&#47;04&#47;04&#47;Initialization_angularjs&#47;" />   <meta property="og:image:width" content="623" /> <meta property="og:image:height" content="467" />  <link href='//fonts.googleapis.com/css?family=Roboto:300,700&subset=latin,cyrillic,cyrillic-ext' rel='stylesheet' type='text/css'>  <link rel="stylesheet" href="/css/app.min.2.1.0.css">  <script src="/js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script> <!-- place this in your head tag --> <!-- <script src='https://js.tito.io/v1' async></script> --> <!-- <link rel="stylesheet" type="text/css" href='https://css.tito.io/v1' /> --></head><body data-spy="scroll" data-target=".navbar" data-offset="150"><!--[if lt IE 8]><p class="chromeframe">Вы используете <strong>устаревший</strong> браузер. Пожалуйста <a href="http://browsehappy.com/">обновите ваш браузер</a> или <a href="http://www.google.com/chromeframe/?redirect=true">активируйте Google Chrome Frame</a>, чтобы улучшить ваши впечатления от посещения сайта.</p><![endif]--><header class="navbar navbar-inverse navbar-fixed-top"> <div class="navbar-inner"> <div class="container"> <div class="social-desktop"> <a class="fcb" href="https://www.facebook.com/makeomatic"> <i class="fa fa-facebook"></i> </a> <a class="vk" href="https://vk.com/makeomatic"> <i class="fa fa-vk"></i> </a> <a class="twt" href="https://twitter.com/MakeOmatic"> <i class="fa fa-twitter"></i> </a> <a class="gp" href="https://google.com/+MakeomaticRu"> <i class="fa fa-google-plus-square"></i> </a> </div> <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> <a class="brand" href="/">makeomatic</a> <div class="nav-collapse collapse"> <ul class="nav">   <li class='active '> <a href="/blog" > Блог  </a>  </li>   <li class=' dropdown'> <a href="/team" data-target="#" class="dropdown-toggle" data-toggle="dropdown"> Команда  <b class='caret'></b>  </a>  <ul class='dropdown-menu'>   <li> <a href="/team#vyacheslavgusev">Вячеслав Гусев</a> </li>   <li> <a href="/team#vitaliiaminev">Виталий Аминев</a> </li>   <li> <a href="/team#annaamineva">Анна Аминева</a> </li>   <li> <a href="/team#andreiafoninskii">Андрей Афонинский</a> </li>   <li> <a href="/team#aleksandrkremenets">Александр Кременец</a> </li>   <li> <a href="/team#dmitriigorbunov">Дмитрий Горбунов</a> </li>   <li> <a href="/team#evgeniipoyarkov">Евгений Поярков</a> </li>   <li> <a href="/team#ilyaovsyannikov">Илья Овсянников</a> </li>  </ul>  </li>   <li class=' '> <a href="/#about" > О нас  </a>  </li>   <li class=' dropdown'> <a href="/#portfolio" data-target="#" class="dropdown-toggle" data-toggle="dropdown"> Портфолио  <b class='caret'></b>  </a>  <ul class='dropdown-menu'>   <li> <a href="/#Distribut.io">Distribut.io</a> </li>   <li> <a href="/#Recordi">Recordi</a> </li>   <li> <a href="/#Photobot">Photobot</a> </li>   <li> <a href="/#BrainsApp">BrainsApp</a> </li>   <li> <a href="/#FabrikaTepla">FabrikaTepla</a> </li>   <li> <a href="/#SpeakGeo">SpeakGeo</a> </li>   <li> <a href="/#OpenInclude">OpenInclude</a> </li>   <li> <a href="/#LIVEONE">LIVEONE</a> </li>   <li> <a href="/#FitCafe">FitCafe</a> </li>  </ul>  </li>   <li class=' '> <a href="/#tech" > Технологии  </a>  </li>   <li class=' '> <a href="#contacts" > Контакты  </a>  </li>  </ul> </div><!--/.nav-collapse --> <div class='send-brief' > <a href='#brief' role='button' data-toggle='modal'> <i class='background'></i> <span>Заполнить бриф</span> </a> </div> <h4 class='phone-desktop'> Звоните: +7 (495) 79-222-44 </h4> </div> </div></header><div class="icon-up visible-desktop" id="up" title="наверх"></div><section class="container blog" id='blog'> <h1 class='outlined-caption text-center'> <a href='/blog'>Блог Makeomatic: разработка сайтов и мобильных приложений</a> </h1>  <div class='row'> <div class='span10'><article class="post"> <div class="post-content"> <header class='post-header'>   <h2 class="title">Последовательная асинхронная инициализация Angular.JS приложений с использованием промисов</h2> <p class='muted'></p>   <div class="icon"></div> <time datetime="2014-04-04T07:00:00.000Z"> Apr 4 2014 </time>   <div class="tags"> | Категории: <a href="/blog/tags/AngularJS/">AngularJS</a>, <a href="/blog/tags/Javascript/">Javascript</a> </div> <span class='author'><img src='//www.gravatar.com/avatar/20f85f2eff5b6d1983bc8b0d1cd37a42?s=20' /> Анна Аминева</span>  </header> <section class="body">  <p><img src="/blog/images/Initialization.jpg" alt="Иллюстрация блокнота"></p>
<p>AngularJS помогает загружать ваше приложение путем внедрения зависимостей, основываясь на упорядоченном создании экземпляров классов. Тем не менее, иногда вам нужно знать завершился ли один из текущих запросов или вызовов функций для того, чтобы инициализировать ваши контроллеры, <code>$scope</code> или сервисы. Эта статья описывает наше решение, которое разбивает жизненный цикл приложения на несколько фраз, названных “instantiation” (начальное создание экземпляров классов), “initialization” (их инициализация) и “running” (работающий режим). Вы можете найти в GitHub загрузочный код и работающую в jsfiddle демо версию.</p>
<a id="more"></a>
<h3 id="Наивная_реализация">Наивная реализация</h3><p>Пример внизу демонстрирует как вы даете Angularjs внедрять другие сервисы в ваш контроллер или сервис:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">myModule.service(<span class="string">'myService'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.getOptions = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> [&#123;name:<span class="string">'entry1'</span>, value:<span class="number">0</span>&#125;,</span><br><span class="line">               &#123;name:<span class="string">'entry2'</span>, value:<span class="number">1</span>&#125;];</span><br><span class="line">   &#125;;</span><br><span class="line">&#125;);</span><br><span class="line">myModule.controller(<span class="string">'simpleController'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$scope, myService</span>) </span>&#123;</span><br><span class="line">   $scope.options = myService.getOptions();</span><br><span class="line">   $scope.selectedOption = $scope.options[<span class="number">0</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>Вы видите <code>simpleController</code>, использующий некоторые переменные, переданные из <code>myService</code>. Реализация <code>getOptions</code> возвращает статичный список строк, который в конце концов используется в контроллере, для конфигурирования его <code>$scope</code>.<br>Теперь давайте предположим что мы не можем просто вернуть статичный список строк, но нам нужно выполнить http-вызов к бекэнду. В добавление к запросу, давайте добавим <code>$watch</code> к <code>selectedOption</code>, так как он привязан к выпадающему меню и мы хотим обрабатывать любое нажатие пользователя, приводящего к изменению текущего состояния (посмотрите  <a href="http://jsfiddle.net/gesellix/r2xWm/" target="_blank" rel="external">jsfiddle demo 1</a>)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myModule = angular.module(<span class="string">'myModule'</span>, []);</span><br><span class="line">myModule.service(<span class="string">'myService'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$http</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.getOptions = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> $http(&#123;</span><br><span class="line">           <span class="string">"method"</span>: <span class="string">"get"</span>,</span><br><span class="line">           <span class="string">"url"</span>: <span class="string">'http://www.example.com/echo/json/'</span></span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;;</span><br><span class="line">&#125;);</span><br><span class="line">myModule.controller(<span class="string">'simpleController'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$scope, myService</span>) </span>&#123;</span><br><span class="line">   $scope.selectedOption = <span class="literal">null</span>;</span><br><span class="line">   $scope.options = [];</span><br><span class="line">   myService.getOptions().then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">       $scope.options = result.data.options;</span><br><span class="line">       $scope.selectedOption = <span class="number">0</span>;</span><br><span class="line">   &#125;);</span><br><span class="line">   $scope.$watch(<span class="string">'selectedOption'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">newValue, oldValue</span>) </span>&#123;</span><br><span class="line">       <span class="comment">// handle selection change ...</span></span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">"selection: "</span> + $scope.selectedOption);</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>При запуске кода вы дважды заметите вызов <code>console.log</code>. Первый вывод в лог был вызван Ангуляром из-за добавления <code>$watch</code>, второй вывод запущен успешно отработанным промисом, когда мы присваиваем <code>selectedOption</code> ноль.  Обе записи в лог иллюстрируют ситуацию, в которой не пользователь кликнул на что-то,  а само приложение внесло изменение в течение фазы загрузки. Пример всего лишь логирует информацию в консоль, но вы, конечно, будете реализовывать более сложную логику и можете предпочесть, чтобы вас уведомляли только когда сам пользователь менял какие-либо значения. Код добавляющий <code>$watch</code> на <code>selectedOption</code>, можно переместить внутрь обработчика успешного промиса, но один из триггеров все еще будет срабатывать, поэтому такой подход не является оптимальным решением.</p>
<p>Вы можете представить, что добавление большего количества сервисов в дерево зависимостей и добавление большего количества <code>$watches</code> или слушателей событий все еще ухудшает. Пример сверху не имеет значительных проблем, но у нас есть большее и более сложное приложение с большим количеством зависимостей в течение его жизненного цикла и некоторых предположений о валидном состоянии в $scope.</p>
<h3 id="Реализация_с_учетом_стадии_инициализации">Реализация с учетом стадии инициализации</h3><p>Мы пришли к ситуации, которая показала, что всего лишь одно добавление <code>$watches</code> в одном месте запустило поток несвоевременных действий в различных частях вашего приложения, что не позволило вашим контроллерам или сервисам правильно инициализироваться. Эти события необходимо было или отфильтровать или отключать на такой ранней фазе. Мы предпочли не создавать полную машину состояний или использовать фреймворк, имеющий ее в своем ядре, потому что мы рассматриваем нашу фазу инициализации лишь как маленькую частью нашего жизненного цикла приложения - не говоря о том, что ее влияние является не таким значительным.<br>Наш подход заключался в том, что мы разрешили контроллерам объявлять их задачи для инициализации и решили создать сервис, который будет координировать каждый из этих задач. Более того, нам не нравятся <code>$watch</code> триггеры при их инициализации,  так что мы решили избавиться и от них.<br>Пример внизу показывает контроллер с выделенным местом для инициализирующего кода:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myModule = angular.module(<span class="string">'myModule'</span>, []);</span><br><span class="line">myModule.service(<span class="string">'myService'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$http</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.getOptions = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> $http(&#123;</span><br><span class="line">           <span class="string">"method"</span>: <span class="string">"get"</span>,</span><br><span class="line">           <span class="string">"url"</span>: <span class="string">'http://www.example.com/echo/json/'</span></span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;;</span><br><span class="line">&#125;);</span><br><span class="line">myModule.controller(<span class="string">'simpleController'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$scope, myService, init</span>) </span>&#123;</span><br><span class="line">   $scope.selectedOption = <span class="literal">null</span>;</span><br><span class="line">   $scope.options = [];</span><br><span class="line">   init(<span class="string">'simpleController'</span>, [myService.getOptions()], <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">       $scope.options = result.data.options;</span><br><span class="line">       $scope.selectedOption = <span class="number">0</span>;</span><br><span class="line">   &#125;);</span><br><span class="line">   init.watchAfterInit($scope, <span class="string">'selectedOption'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">newValue, oldValue</span>) </span>&#123;</span><br><span class="line">       <span class="comment">// handle selection change ...</span></span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">"selection: "</span> + $scope.selectedOption);</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Код не сильно отличается от исходного примера, потому что самая важная часть спрятана в <code>init</code> сервисе, который был введен как новая зависимость. Мы изменили вызов к <code>myService.getOptions()</code> так, что init сервис может решать когда доставить результат вызова к бекэнду в <code>simpleController</code>. Кроме того мы завернули вызов $watch так, что init  сервис тоже мог решать какие $watch триггеры могут поступить в <code>callback</code> функцию <code>simpleController</code>.</p>
<h3 id="Сервис_инициализации_в_AngularJS">Сервис инициализации в AngularJS</h3><p>Нам нужно, чтобы и <code>$watch</code>, и <code>$on</code> оказались инкапсулированы <code>init</code> сервисом. Вот как выглядит наша текущая реализация:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.factory(<span class="string">'init'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> initialized = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> init = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;;</span><br><span class="line">  init.watchAfterInit = <span class="function"><span class="keyword">function</span> (<span class="params">scope, expression, listener, deepEqual</span>) </span>&#123;</span><br><span class="line">    scope.$watch(expression, <span class="function"><span class="keyword">function</span> (<span class="params">newValue, oldValue, listenerScope</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">        listener(newValue, oldValue, listenerScope);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, deepEqual);</span><br><span class="line">  &#125;;</span><br><span class="line">  init.onAfterInit = <span class="function"><span class="keyword">function</span> (<span class="params">scope, event, listener</span>) </span>&#123;</span><br><span class="line">    scope.$on(event, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">        listener(event);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span>  init;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>Обе функции <code>watchAfterInit</code> и <code>onAfterInit</code> отделены от остальной части сервиса инициализации, кроме флага <code>initialized</code>, который отвечает за состояние сервиса инициализации.<br>Функция <code>AfterInit</code> решает две проблемы, упомянутые выше: </p>
<ol>
<li>не пропускает начальный триггер $watch, см <a href="http://docs.angularjs.org/api/ng.$rootScope.Scope#$watch" target="_blank" rel="external">AngularJS docs</a></li>
<li>не публикует события и триггеры $watch до полного завершения начальной инициализации приложения<br>В добавок к функции <code>AfterInit</code>, сервис инициализации управляет несколькими сервисами, где сконфигурирована функция <code>init (...)</code>. В примере сверху мы добавили функцию инициализации к <code>simpleController</code>, которая реализована как показано ниже. Вы можете найти сравнение первой демо версии и новой реализации в <a href="http://jsfiddle.net/gesellix/xxKjw/" target="_blank" rel="external">jsfiddle demo 2</a>.</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">.factory(<span class="string">'init'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$q, $rootScope, $browser</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">var</span> initFunctions = [</span><br><span class="line">   <span class="string">'simpleController'</span>,</span><br><span class="line">   <span class="string">'anotherController'</span>,</span><br><span class="line">   <span class="string">'thirdController'</span></span><br><span class="line"> ];</span><br><span class="line"> <span class="keyword">var</span> registeredInitFunctions = &#123;&#125;;</span><br><span class="line"> <span class="keyword">var</span> initialized = <span class="literal">false</span>;</span><br><span class="line"> <span class="keyword">var</span> initApplication = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> simpleController = registeredInitFunctions[<span class="string">'simpleController'</span>];</span><br><span class="line">   <span class="keyword">var</span> anotherController = registeredInitFunctions[<span class="string">'anotherController'</span>];</span><br><span class="line">   <span class="keyword">var</span> thirdController = registeredInitFunctions[<span class="string">'thirdController'</span>];</span><br><span class="line">   <span class="keyword">var</span> broadcastAppInitialized = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">     $browser.defer(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       initialized = <span class="literal">true</span>;</span><br><span class="line">       $rootScope.$apply(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">         $rootScope.$broadcast(<span class="string">'appInitialized'</span>);</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;;</span><br><span class="line">   simpleController.init()</span><br><span class="line">     .then(anotherController.init)</span><br><span class="line">     .then(thirdController.init)</span><br><span class="line">     .then(broadcastAppInitialized);</span><br><span class="line"> &#125;;</span><br><span class="line"> $rootScope.$on(<span class="string">'$routeChangeStart'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   registeredInitFunctions = &#123;&#125;;</span><br><span class="line">   initialized = <span class="literal">false</span>;</span><br><span class="line"> &#125;);</span><br><span class="line"> <span class="keyword">var</span> initAppWhenReady = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> registeredInitFunctionNames = _.keys(registeredInitFunctions);</span><br><span class="line">   <span class="keyword">var</span> isRegistered = _.partial(_.contains, registeredInitFunctionNames);</span><br><span class="line">   <span class="keyword">if</span> (_.every(initFunctions, isRegistered)) &#123;</span><br><span class="line">     initApplication();</span><br><span class="line">     registeredInitFunctions = <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="keyword">var</span> init = <span class="function"><span class="keyword">function</span> (<span class="params">name, dependencies, initCallback</span>) </span>&#123;</span><br><span class="line">   registeredInitFunctions[name] = &#123;</span><br><span class="line">     init: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">var</span> internalDependencies = $q.all(dependencies);</span><br><span class="line">       <span class="keyword">return</span> internalDependencies.then(initCallback);</span><br><span class="line">     &#125;&#125;;</span><br><span class="line">   initAppWhenReady();</span><br><span class="line"> &#125;;</span><br><span class="line"> init.watchAfterInit = <span class="function"><span class="keyword">function</span> (<span class="params">scope, expression, listener, deepEqual</span>) </span>&#123;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line"> &#125;;</span><br><span class="line"> init.onAfterInit = <span class="function"><span class="keyword">function</span> (<span class="params">scope, event, listener</span>) </span>&#123;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="keyword">return</span>  init;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Чтобы показать вам как согласовать более сложную структуру, мы объявили два дополнительных контроллера <code>anotherController</code> и <code>thirdController</code>, но базовая идея не зависит от количества инициализированных контроллеров или сервисов.</p>
<h3 id="Как_это_работает">Как это работает</h3><p>Наш сервис инициализации по существу должен решить когда переключить флаг <code>initialized</code> на <code>true</code>. Существует несколько ступеней, необходимых для достижения запущенного состояния:</p>
<ol>
<li>все <code>initFunctions</code> нужно зарегистрировать через init(…)</li>
<li>как только все initFunctions зарегистрированы, <code>initAppWhenReady()</code> вызывает функцию инициализации <code>initApplication()</code></li>
<li><code>initApplication()</code> вызывает каждую <code>initFunction</code> в указанном порядке. Используя промисы, она ждет, чтобы каждая <code>initFunction</code> завершилась, прежде чем вызвать следующую <code>initFunction</code></li>
<li>Наконец,  вызывается <code>broadcastAppInitialized()</code></li>
</ol>
<p>Первый шаг преобразовывает каждый init(…) вызова путем обертывания возвращаемого значения зависимости (которая, как ожидается, является промисом) в <code>$q.all(…)</code> и делает так, что initCallback вызывается только после того, как все промисы будут исполнены. Таким образом, сервис инициализации генерирует функции инициализации и запоминает их во внутреннем объекте <code>registeredInitFunctions</code>.</p>
<p><code>initAppWhenReady()</code> проверяется при каждом добавлении к <code>registeredInitFunctions</code>, были ли собраны все ожидаемые initFunctions. Ожидаемые initFunctions объявляются во внутреннем списке и будут изменяемой частью сервиса инициализации.</p>
<p><code>initApplication()</code> знает порядок вызовов к <code>initFunction</code>, и может получить доступ к каждой зарегистрированной <code>initFunction</code> и вызвать их по порядку. Используя промисы, нет необходимости создавать дополнительные коллбэки и код может быть написан в виде простой цепи.</p>
<p>Последняя ступень в цепи переключает <code>initialized</code> флаг, так, что будущие события и $watch триггеры не будут скрываться сервисом инициализации. Более того, сервис распространяет событие <code>appInitialized</code> таким образом, что другие части нашего приложения могут среагировать на завершение фазы инициализации как можно скорее. Вы заметите <code>$browser.defer(...)</code> вокруг вызовов переключения и бродкаста флага. Чтобы понять причины, вам нужно знать об AngularJS <a href="http://docs.angularjs.org/guide/scope#what-are-scopes_integration-with-the-browser-event-loop" target="_blank" rel="external">$digest loop</a>. Используя <code>$browser.defer</code>, мы даем циклу $digest закончиться и поставить в очередь наш завершающий шаг после всех текущих задач. Таким образом мы препятствуем нашему сервису инициализации опубликовывать события <code>$watch/$on</code> слишком рано. Так как <code>$browser.defer</code> не вызывает нашу функцию обратного вызова во время <code>$digest</code> цикла, нам нужно компенсировать это обертыванием <code>$broadcast()</code> в вызов <code>$rootScope.$apply()</code>. </p>
<p>###Выводы</p>
<p>После того, как мы явным образом подумали о разделении жизненного цикла приложения на несколько фаз, мы получили более полное представление о том, как интегрироваться с AngularJS и его стандартным жизненным циклом. Наши тесты были улучшены с помощью тестирования инициализации (где это было возможно) и нормальным взаимодействием в выделенных контекстах.<br>Сервис инициализации совсем не заметен для обычных сервисов и контроллеров. Только когда необходимо, любой контроллер может быть добавлен в цепь инициализации. Как только инициализация завершена, сервис инициализации становится пассивным. Только во время изменений $route и перезапусков контроллеров, сервис инициализации должен быть сброшен, что решается реагированием на <code>$routeChangeStart</code> событие.<br>Хранение текущего состояния внутри сервиса инициализации может считаться плохим решением, но так как все сервисы AngularJS спроектированы как синглтоны и Javascript - однопоточен, в данный момент у нас нет никаких проблем. </p>
  </section> <footer class='post-footer clearfix'>   <div class="addthis_toolbox addthis_default_style pull-right"> <a class="addthis_button_facebook"></a> <a class="addthis_button_twitter"></a> <a class="addthis_button_vk"></a> <a class="addthis_button_compact"></a> <a class="addthis_counter addthis_bubble_style"></a></div><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>  </footer> </div></article><section id="comment"> <h3 class="title">Комментарии</h3> <div id="disqus_thread"> <noscript>Включите Javascript, чтобы просмотреть <a href="//disqus.com/?ref_noscript">комментарии с помощью Disqus.</a></noscript> </div></section></div> <aside class="span2">  <div class="widget tag"> <h3 class="title">Тэги</h3> <ul class="unstyled">  <li> <span class='badge'>31</span> <a href="/blog/tags/AngularJS/"> AngularJS </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/CSS/"> CSS </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Chef/"> Chef </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Coffee-script/"> Coffee-script </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Cordova/"> Cordova </a> </li>  <li> <span class='badge'>5</span> <a href="/blog/tags/ElasticSearch/"> ElasticSearch </a> </li>  <li> <span class='badge'>5</span> <a href="/blog/tags/FAQ/"> FAQ </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/GitHub/"> GitHub </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/HTML5/"> HTML5 </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/ItProjects/"> ItProjects </a> </li>  <li> <span class='badge'>29</span> <a href="/blog/tags/Javascript/"> Javascript </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Mongoose/"> Mongoose </a> </li>  <li> <span class='badge'>9</span> <a href="/blog/tags/Node-js/"> Node.js </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/NodeJS/"> NodeJS </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Objective-C/"> Objective-C </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/PhoneGap/"> PhoneGap </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/RabbitMQ/"> RabbitMQ </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/SEO/"> SEO </a> </li>  <li> <span class='badge'>3</span> <a href="/blog/tags/SQL/"> SQL </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/YAC2014/"> YAC2014 </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/bash/"> bash </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/iOS7/"> iOS7 </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/jQuery/"> jQuery </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Бизнес-модель/"> Бизнес модель </a> </li>  <li> <span class='badge'>4</span> <a href="/blog/tags/Для-новичков/"> Для новичков </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Жизнь-компании/"> Жизнь компании </a> </li>  </ul></div></aside> </div></section> <!-- /container --><footer id='contacts' class='footer-main'> <div class='callback'> <div class='container'> <div class='row'> <div class='span12'> <h2 class='xlarge'>Есть вопросы или предложения?</h2> <p class='outlined-caption'>закажите обратный звонок и наш менеджер перезвонит вам</p> <form method='POST' action='/brief' id='callback'> <ul class='hidden error'></ul> <input type="text" name='name' placeholder="Как к вам обратиться?" class='span12' required /> <input type="text" name='phone' placeholder="По какому номеру звонить?" class='span6' /> <input type="email" name='email' placeholder="E-mail (опционально)" class='span6 pull-right' /> <textarea name='question' placeholder="Ваш вопрос (опционально)" class='span12'></textarea> <button type="submit" class='blue-plank'>Заказать звонок</button> </form> </div> </div> </div> </div> <div class='container'> <div class='row'> <div class='span6'> <h4 class='footer-caption'>Разделы сайта</h4> <ul class="nav inline">  <li><a href="/blog">Блог</a></li>  <li><a href="/team">Команда</a></li>  <li><a href="#about">О нас</a></li>  <li><a href="#portfolio">Портфолио</a></li>  <li><a href="#tech">Технологии</a></li>  <li><a href="#contacts">Контакты</a></li>  <li><a href='https://github.com/AVVSDevelopment/avvs.co'>Проект на GitHub</a></li> </ul> <p class='copyright'>Makeomatic, (c) 2012-2014<br/>Разработка сайтов и мобильных приложений</p> </div> <div class='span6 blue-line'> <h4 class='footer-caption'>Контакты</h4> <p> тел: +7 (495) 79-222-44 </p> <p> e-mail: <a href="mailto:getstarted@makeomatic.ru">getstarted@makeomatic.ru</a> </p> <address> Россия, Москва, Ленинский пр-т, дом 30а<br/>индекс: 111555 </address> <div class="social"> <a class="fcb fa-stack fa-lg" href="https://www.facebook.com/makeomatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i> </a> <a class="fa-stack fa-lg" href="http://vk.com/makeomatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-vk fa-stack-1x fa-inverse"></i> </a> <a class="twt fa-stack fa-lg" href="https://twitter.com/MakeOmatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </a> <a class="gp fa-stack fa-lg" href="https://google.com/+MakeomaticRu"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i> </a> </div> </div> </div> </div></footer><div class="modal hide fade brief" id='brief'> <div class="modal-body"> <div class='text-center'> <h2 class='brief-header outlined-caption'>Расскажите нам о вашем проекте</h2> <p class='small'> Коротко опишите ваши идеи или просто прикрепите файл с готовым ТЗ.<br/> Мы свяжемся с вами в течение 1 дня и подробно расскажем о том, как мы можем вам помочь. </p> </div> <form method='POST' action='/brief' class='callback'> <input type="text" name='name' placeholder="Как к вам обратиться?" class='span10' required /> <input type="text" name='phone' placeholder="По какому номеру звонить?" class='span5' /> <input type="email" name='email' placeholder="E-mail (опционально)" class='span5 pull-right' /> <textarea name='question' placeholder="Краткое описание вашего проекта" class='span7'></textarea> <div class='dropbox pull-right' id='dropbox' ></div> <button class="blue-plank pull-right" type='submit'>Отправить</button> </form> </div></div><!-- scripts --><script src="/js/app.min.2.1.0.js" charset="UTF-8" ></script><!-- end scripts --><script type="text/javascript">var disqus_shortname = 'makeomatic';(function(){ var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);}());</script><!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter15629977 = new Ya.Metrika({id:15629977, webvisor:true, clickmap:true, trackLinks:true, accurateTrackBounce:true, trackHash:true, ut:"noindex"}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/15629977?ut=noindex" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter --><!-- google analytics --><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-40638966-1', 'makeomatic.ru'); ga('send', 'pageview');</script></body></html>