<!DOCTYPE html><!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="ru"> <![endif]--><!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang="ru"> <![endif]--><!--[if IE 8]>         <html class="no-js lt-ie9" lang="ru"> <![endif]--><!--[if gt IE 8]><!--> <html class="no-js" lang="ru"> <!--<![endif]--><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#"> <meta charset="utf-8">  <title>Приёмы и хитрости для быстрой front-end разработки | Блог Makeomatic: разработка сайтов и мобильных приложений</title> <meta name="author" content="Makeomatic">  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"> <!-- For third-generation iPad with high-resolution Retina display: --> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144x144-precomposed.png"> <!-- For iPhone with high-resolution Retina display running iOS ≥ 7: --> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/apple-touch-icon-120x120-precomposed.png"> <!-- For iPhone with high-resolution Retina display running iOS ≤ 6: --> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png"> <!-- For first- and second-generation iPad: --> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png"> <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: --> <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"> <meta name="description" content="ВступлениеДавайте по-честному, настраивая инструмент для сборки проектов (таск-менеджер), большинство разработчиков ищут предыдущий проект с подходящей структурой и просто копируют Grunt или Gulp файл">
<meta property="og:type" content="article">
<meta property="og:title" content="Приёмы и хитрости для быстрой front-end разработки">
<meta property="og:url" content="https://makeomatic.ru/blog/2014/12/06/Tips_and_Tricks/index.html">
<meta property="og:site_name" content="Блог Makeomatic: разработка сайтов и мобильных приложений">
<meta property="og:description" content="ВступлениеДавайте по-честному, настраивая инструмент для сборки проектов (таск-менеджер), большинство разработчиков ищут предыдущий проект с подходящей структурой и просто копируют Grunt или Gulp файл">
<meta property="og:image" content="https://makeomatic.ru/blog/images/tips.jpg">
<meta property="og:updated_time" content="2015-05-27T05:04:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Приёмы и хитрости для быстрой front-end разработки">
<meta name="twitter:description" content="ВступлениеДавайте по-честному, настраивая инструмент для сборки проектов (таск-менеджер), большинство разработчиков ищут предыдущий проект с подходящей структурой и просто копируют Grunt или Gulp файл">
<meta name="twitter:creator" content="@makeomatic">
<link rel="publisher" href="https://plus.google.com/+MakeomaticRu">  <link rel="alternate" hreflang="ru" href="https:&#47;&#47;makeomatic.ru&#47;blog&#47;2014&#47;12&#47;06&#47;Tips_and_Tricks" />   <meta property="og:image:width" content="623" /> <meta property="og:image:height" content="436" />  <link href='//fonts.googleapis.com/css?family=Roboto:300,700&subset=latin,cyrillic,cyrillic-ext' rel='stylesheet' type='text/css'>  <link rel="stylesheet" href="/css/app.min.2.1.0.css">  <script src="/js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script> <!-- place this in your head tag --> <!-- <script src='https://js.tito.io/v1' async></script> --> <!-- <link rel="stylesheet" type="text/css" href='https://css.tito.io/v1' /> --></head><body data-spy="scroll" data-target=".navbar" data-offset="150"><!--[if lt IE 8]><p class="chromeframe">Вы используете <strong>устаревший</strong> браузер. Пожалуйста <a href="http://browsehappy.com/">обновите ваш браузер</a> или <a href="http://www.google.com/chromeframe/?redirect=true">активируйте Google Chrome Frame</a>, чтобы улучшить ваши впечатления от посещения сайта.</p><![endif]--><header class="navbar navbar-inverse navbar-fixed-top"> <div class="navbar-inner"> <div class="container"> <div class="social-desktop"> <a class="fcb" href="https://www.facebook.com/makeomatic"> <i class="fa fa-facebook"></i> </a> <a class="vk" href="https://vk.com/makeomatic"> <i class="fa fa-vk"></i> </a> <a class="twt" href="https://twitter.com/MakeOmatic"> <i class="fa fa-twitter"></i> </a> <a class="gp" href="https://google.com/+MakeomaticRu"> <i class="fa fa-google-plus-square"></i> </a> </div> <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> <a class="brand" href="/">makeomatic</a> <div class="nav-collapse collapse"> <ul class="nav">   <li class='active '> <a href="/blog" > Блог  </a>  </li>   <li class=' dropdown'> <a href="/team" data-target="#" class="dropdown-toggle" data-toggle="dropdown"> Команда  <b class='caret'></b>  </a>  <ul class='dropdown-menu'>   <li> <a href="/team#vyacheslavgusev">Вячеслав Гусев</a> </li>   <li> <a href="/team#vitaliiaminev">Виталий Аминев</a> </li>   <li> <a href="/team#annaamineva">Анна Аминева</a> </li>   <li> <a href="/team#andreiafoninskii">Андрей Афонинский</a> </li>   <li> <a href="/team#aleksandrkremenets">Александр Кременец</a> </li>   <li> <a href="/team#dmitriigorbunov">Дмитрий Горбунов</a> </li>   <li> <a href="/team#evgeniipoyarkov">Евгений Поярков</a> </li>   <li> <a href="/team#ilyaovsyannikov">Илья Овсянников</a> </li>  </ul>  </li>   <li class=' '> <a href="/#about" > О нас  </a>  </li>   <li class=' dropdown'> <a href="/#portfolio" data-target="#" class="dropdown-toggle" data-toggle="dropdown"> Портфолио  <b class='caret'></b>  </a>  <ul class='dropdown-menu'>   <li> <a href="/#Distribut.io">Distribut.io</a> </li>   <li> <a href="/#Recordi">Recordi</a> </li>   <li> <a href="/#Photobot">Photobot</a> </li>   <li> <a href="/#BrainsApp">BrainsApp</a> </li>   <li> <a href="/#FabrikaTepla">FabrikaTepla</a> </li>   <li> <a href="/#SpeakGeo">SpeakGeo</a> </li>   <li> <a href="/#OpenInclude">OpenInclude</a> </li>   <li> <a href="/#LIVEONE">LIVEONE</a> </li>   <li> <a href="/#FitCafe">FitCafe</a> </li>  </ul>  </li>   <li class=' '> <a href="/#tech" > Технологии  </a>  </li>   <li class=' '> <a href="#contacts" > Контакты  </a>  </li>  </ul> </div><!--/.nav-collapse --> <div class='send-brief' > <a href='#brief' role='button' data-toggle='modal'> <i class='background'></i> <span>Заполнить бриф</span> </a> </div> <h4 class='phone-desktop'> Звоните: +7 (495) 79-222-44 </h4> </div> </div></header><div class="icon-up visible-desktop" id="up" title="наверх"></div><section class="container blog" id='blog'> <h1 class='outlined-caption text-center'> <a href='/blog'>Блог Makeomatic: разработка сайтов и мобильных приложений</a> </h1>  <div class='row'> <div class='span10'><article class="post"> <div class="post-content"> <header class='post-header'>   <h2 class="title">Приёмы и хитрости для быстрой front-end разработки</h2> <p class='muted'></p>   <div class="icon"></div> <time datetime="2014-12-06T08:00:00.000Z"> Dec 6 2014 </time>   <div class="tags"> | Категории: <a href="/blog/tags/AngularJS/">AngularJS</a>, <a href="/blog/tags/Javascript/">Javascript</a> </div> <span class='author'><img src='//www.gravatar.com/avatar/533bf2bc5b98773298fa3715a5e286ee?s=20' /> Eleonora Pavlova</span>  </header> <section class="body">  <p><img src="/blog/images/tips.jpg" alt="Иллюстрация блокнота"></p>
<h3 id="Вступление">Вступление</h3><p>Давайте по-честному, настраивая инструмент для сборки проектов (таск-менеджер), большинство разработчиков ищут предыдущий проект с подходящей структурой и просто копируют Grunt или Gulp файл и вносят необходимые правки (меняют названия папок для нового проекта и так далее).<br><a id="more"></a></p>
<p>Даже переход с одного таск-менеджера Grunt на другой, более новый, Gulp – это обычно поиск соответсвующего npm-пакета для Gulp, наподобие аналогичного плагина grunt-contrib. Раньше работали со связкой Grunt-contrib-Stylus? Значит, для нового таск-менеджера выбираем Gulp-Stylus. Необходим grunt-contrib-jshint? Наверняка, аналогичный пакет gulp-jshint выполняет те же задачи. А дальше — лишь соответствующие изменения синтактиса. </p>
<p>Таким способом можно быстро и особо не задумываясь настроить таск-менеджер для маленьких проектов. Но после нескольких месяцев работы в Pellucid над приложением, которое в моей практике является самым крупным проектом на Javascript, когда на выполнение задач такс-менеджера всё чаще должно уходить не более 10 секунд, пришлось задуматься об оптимизации.</p>
<p>###Представляем наш демонстрационный проект</p>
<p>В качестве небольшого примера для тестов и экспериментов, я создал <a href="https://github.com/mlms13/build-optimizations" target="_blank" rel="external">демо-репозиторий</a>. В проекте используется jQuery, Lo-dash и Handlebars, а также порядка 50 CommonJS модулей (около 0,5 Mb), чтобы Browserify было, с чем работать.</p>
<p>В этом репозитории наш идеальный таск-менеджер (идеальный вдвойне, потому что очень быстрый — но об этом чуть позже) будет делать следующее: </p>
<ul>
<li>предварительная обработка, префиксация и сжатие CSS; </li>
<li>анализ нашего javascript-кода с подсказками (Lint/Hint), сборка файлов с Browserify и их минификация с Uglify; </li>
<li>отслеживание изменений и применение к ним задач, указанных выше.</li>
</ul>
<p>В наших рабочих проектах Pellucid задач при настройке таск-менеджера обычно бывает больше, но эти — самые времязатратные, и в этом примере мы рассмотрим  общий случай,  применимый ко многим front-end проектам. </p>
<h3 id="Ускорим_процессы">Ускорим процессы</h3><p>В идеальном мире наш Gulpfile мог бы выглядеть <a href="https://github.com/mlms13/build-optimizations/blob/master/Gulpfile.js" target="_blank" rel="external">так</a>. Довольно просто: мы взяли наш список преобразований и разбили его на Gulp-задачи. Код быстро пишется, легко читается и выполняет всё, что от него требуется.</p>
<p>Однако, даже в нашем сравнительно небольшом демо-приложении, на моём ноутбуке это занимает более 4 секунд (показатель time gulp). Для первоначальной компиляции это допустимое время, но в связи с рекомпиляцией после каждого внесённого изменения благодаря нашей команде watch, время ожидания на тестирование наших изменений становится значительным.  </p>
<p>Давайте запустим одни из самых медленных процессов и подумаем, как их ускорить.</p>
<h4 id="Связка_Browserify-Watchify">Связка Browserify-Watchify</h4><p>Склеивание модулей с помощью Browserify, пожалуй, наиболее времязатратный процесс в нашей сборке, занимающий около 3 секунд. К счастью, это проще всего исправить. Прежде всего, переключим нашу задачу watch на использование библиотеки <a href="https://github.com/substack/watchify" target="_blank" rel="external">Watchify</a>. Она создана <a href="https://github.com/substack" target="_blank" rel="external">тем же человеком</a>, что и Browserify, и в неё встроен механизм, позволяющий пересобирать только необходимые нам файлы. Для Gulp уже есть <a href="https://github.com/gulpjs/gulp/blob/master/docs/recipes/fast-browserify-builds-with-watchify.md" target="_blank" rel="external">готовый способ сборки с Watchify</a>, воспользуемся им для начала.</p>
<p>Наш js-task будет по-прежнему использовать Browserify (чтобы компилировать Javascript без запуска команды watch) , но давайте вместо gulp-browserify, который <a href="https://github.com/gulpjs/plugins/blob/master/src/blackList.json#L3" target="_blank" rel="external">был внесён в чёрный список разработчиками Gulp</a>, воспользуемся Browserify напрямую. </p>
<p>Прим.: gulp-browserify <a href="https://github.com/deepak1556/gulp-browserify/blob/master/package.json#L14" target="_blank" rel="external">блокирует работу Browserify</a>  в версии 3.x. Используя Browserify напрямую, мы можем работать с последней версией 5.x, в которой другие настройки конфигурации.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">'js'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> browserify = <span class="built_in">require</span>(<span class="string">'browserify'</span>),</span><br><span class="line">      source     = <span class="built_in">require</span>(<span class="string">'vinyl-source-stream'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> browserify(<span class="string">'./js/main.js'</span>, &#123;debug: <span class="literal">true</span>&#125;)</span><br><span class="line">    .bundle()</span><br><span class="line">    .pipe(source()) <span class="comment">// convert to a stream gulp understands</span></span><br><span class="line">    <span class="comment">// ... continue with uglify</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>А для мониторинга нашей системы файлов мы воспользуемся Watchify, вместо аналогичного Gulp watch.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">'watch'</span>, [<span class="string">'stylus'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> watchify   = <span class="built_in">require</span>(<span class="string">'watchify'</span>),</span><br><span class="line">        browserify = <span class="built_in">require</span>(<span class="string">'browserify'</span>),</span><br><span class="line">        bundler    = watchify(browserify(<span class="string">'./js/main.js'</span>, &#123;</span><br><span class="line">            cache: &#123;&#125;,</span><br><span class="line">            packageCache: &#123;&#125;,</span><br><span class="line">            fullPaths: <span class="literal">true</span>,</span><br><span class="line">            transform: [<span class="string">'hbsfy'</span>],</span><br><span class="line">            debug: <span class="literal">true</span></span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">rebundle</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bundler.bundle()</span><br><span class="line">            .pipe(source(<span class="string">'main.js'</span>))</span><br><span class="line">            .pipe(gulp.dest(<span class="string">'./dist'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    bundler.on(<span class="string">'update'</span>, rebundle);</span><br><span class="line">    <span class="comment">// run any other gulp.watch tasks</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rebundle();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Большинство новых параметров, которые мы передаём Browserify, необходимы для работы Watchify. Как вы заметили, мы убрали задачу uglify на этапе watch. Поскольку с помощью этой задачи мы делаем тестовые сборки, не имеет смысла замедлять процесс минификацией.</p>
<p>Теперь, благодаря Watchify, время сборки после пересохранения JS файлов в нашем тестовом проекте уменьшилось с 3-4 секунд до 200 мили-секунд. В Pellucid эти показатели были — с 7 секунд до одной. Одного этого улучшения было бы достаточно, чтобы возгордиться собой и закончить с оптимизацией. Однако, мы можем сделать кое-что ещё.</p>
<h4 id="Дополнительная_оптимизация_Browserify">Дополнительная оптимизация Browserify</h4><p>Если в своём проекте вы используете библиотеки, для работы которых не нужны сторонние модули, Browserify этого не знает, и будет парсить код на предмет команды require() в любом случае, что часто крайне времязатратно. Чтобы ускорить процесс, вы можете передать Browserify массив модулей, которые не нужно парсить:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  browserify(<span class="string">'./js/main.js'</span>, &#123;</span><br><span class="line">    noparse: [<span class="string">'jquery'</span>, <span class="string">'lodash'</span>, <span class="string">'q'</span>]</span><br><span class="line">    <span class="comment">// other options</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>Это никак не скажется на времени наших последующих сборок, зато сэкономит нам 200-300мс при первоначальной сборке. Но имейте в виду, если вы используете browserify-shim и сторонний плагин, вы <a href="https://github.com/thlorenz/browserify-shim/issues/17" target="_blank" rel="external">не сможете</a> использовать noparse в зависимостях этого плагина. И, напоследок, если вы используете Browserify в автономной сборке, которая не зависит от контекста CommonJS, работайте с последней версией Browserify, поскольку предыдущие версии использовали <a href="https://github.com/calvinmetcalf/derequire" target="_blank" rel="external">derequire</a>, что может сильно <a href="https://github.com/substack/node-browserify/issues/633" target="_blank" rel="external">замедлить работу</a> вашей сборки. Если вы ограничены версией ранее 5.x., не включайте в задачу watch автономные сборки.</p>
<h4 id="Фильтруем_неизменённые_файлы">Фильтруем неизменённые файлы</h4><p>Ещё одна задача, занимающая много времени — анализ кода с подсказками (hinting). Работа jshint в нашем демо-репозитории занимает лишь 500мс, однако, в крупном проекте это время доходит до нескольких секунд. </p>
<p>Для работы с Gulp сборками рекомендуется использовать специальные инструменты, и одним из лучших является gulp-cached. Подключаете в вашу сборку <a href="https://github.com/wearefractal/gulp-cached" target="_blank" rel="external">gulp-cached</a>, который кэширует в памяти содержание всех файлов. При последующем выполнении задач, Gulp сначала сравнивает файлы с кэшированными, и подвергает дальнейшим преобразованиям только те файлы, в которые были внесены изменения. </p>
<p>В наших проектах Pellucid эта хитрость экономит несколько секунд в JSHint операциях. Даже в нашем с вами тестовом приложении такой подход уменьшил время на hinting с 500мс до менее 100мс.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">'hint'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> cached  = <span class="built_in">require</span>(<span class="string">'gulp-cached'</span>),</span><br><span class="line">        jshint  = <span class="built_in">require</span>(<span class="string">'gulp-jshint'</span>),</span><br><span class="line">        stylish = <span class="built_in">require</span>(<span class="string">'jshint-stylish'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">'./js/**/*.js'</span>)</span><br><span class="line">      .pipe(cached(<span class="string">'hinting'</span>))</span><br><span class="line">        .pipe(jshint())</span><br><span class="line">        .pipe(jshint.reporter(stylish));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Этот метод будет работать и с другими файлами, которые должны быть обработаны только в случае внесения изменений. Например, если вы сжимаете большое количество изображений, обрабатывая только изменённые фотографии, вы существенно увеличиваете скорость работы. </p>
<p>Если вы беспокоитесь, что это займёт много памяти, особенно в случае с большим количеством изображений, можно установить флаг optimizeMemory, который будет хранить md5 hash вместо полного содержания файлов. Кроме того, можно использовать <a href="https://github.com/sindresorhus/gulp-changed" target="_blank" rel="external">gulp-change</a> и <a href="https://github.com/tschaub/gulp-newer" target="_blank" rel="external">gulp-newer</a>, которые сравнивают временные метки вместо сохранения содержимого в памяти.</p>
<p>Если понадобится вернуть файлы в поток данных, например, если вы применили hint лишь для изменённых файлов, а связать (concatenate) хотите все имеющиеся файлы — это можно сделать с помощью <a href="https://github.com/ahaurw01/gulp-remember" target="_blank" rel="external">gulp-remember</a>.</p>
<h4 id="Разделение_рабочих_задач">Разделение рабочих задач</h4><p>Мы не минифицируем (uglify) нашу тестовую JS-сборку, но можно применить кое-какие хитрости и для рабочих сборок. Это несколько увеличит скорость работы, тк мы будем выполнять операции, необходимые лишь для той или иной сборки. Для начала, разрешим передавать флаг –prod в Gulp сборку с помощью <a href="https://github.com/gulpjs/gulp-util" target="_blank" rel="external">gulp-util</a>, и сохраним в переменной для быстрого доступа.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> gulp  = <span class="built_in">require</span>(<span class="string">'gulp'</span>),</span><br><span class="line">    gutil = <span class="built_in">require</span>(<span class="string">'gulp-util'</span>),</span><br><span class="line">    prod  = gutil.env.prod;</span><br></pre></td></tr></table></figure>
<p>Теперь внутри различных задачек в зависимости от наличия или отсутствия –prod мы либо выполняем нужные операции, либо применяем gutil.noop() , который просто передаётся в поток.</p>
<p>Например, в нашем Browserify таске, мы создадим карты исходников (source maps) для тестовой сборки, а для рабочей — применим Uglify:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">'js'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> browserify = <span class="built_in">require</span>(<span class="string">'browserify'</span>),</span><br><span class="line">      source     = <span class="built_in">require</span>(<span class="string">'vinyl-source-stream'</span>),</span><br><span class="line">      streamify  = <span class="built_in">require</span>(<span class="string">'gulp-streamify'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> browserify(<span class="string">'./js/main.js'</span>, &#123;</span><br><span class="line">      debug: !prod</span><br><span class="line">    &#125;)</span><br><span class="line">    .bundle()</span><br><span class="line">    .pipe(source()) <span class="comment">// convert to a stream gulp understands</span></span><br><span class="line">    .pipe(prod ? stream(uglify()) : gutil.noop())</span><br><span class="line">    .pipe(gulp.dest(<span class="string">'./build'</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Аналогично, в нашем Stylus таске, номера строк (или, если хотите, <a href="https://github.com/stevelacy/gulp-stylus/blob/master/examples/gulpfile.js#L10" target="_blank" rel="external">новые подключенные карты исходников</a>) - для тестовой сборки, а минификация — для рабочей:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">'stylus'</span>, [<span class="string">'cleancss'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> stylus = <span class="built_in">require</span>(<span class="string">'gulp-stylus'</span>),</span><br><span class="line">        prefix = <span class="built_in">require</span>(<span class="string">'gulp-autoprefixer'</span>),</span><br><span class="line">        minify = <span class="built_in">require</span>(<span class="string">'gulp-minify-css'</span>);</span><br><span class="line"></span><br><span class="line">    gulp.src(<span class="string">'./styl/main.styl'</span>)</span><br><span class="line">        .pipe(stylus(&#123;linenos: !prod&#125;))</span><br><span class="line">        .pipe(prefix())</span><br><span class="line">        .pipe(prod ? minify() : gutil.noop())</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./dist/css'</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Если вам привычнее вместо параметра –prod работать с таском gulp prod, можно делать и так, с помощью <a href="https://github.com/OverZealous/run-sequence" target="_blank" rel="external">run-sequence</a>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gulp.task(<span class="string">'setProduction'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// global prod variable that we added above</span></span><br><span class="line">  prod = <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line">gulp.task(<span class="string">'prod'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> sequence = <span class="built_in">require</span>(<span class="string">'run-sequence'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// first set our prod flag, then run other tasks</span></span><br><span class="line">  sequence(<span class="string">'setProduction'</span>, [<span class="string">'stylus'</span>, <span class="string">'js'</span>]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>###Подытожим</p>
<p>Изменения, которые мы внесли в Gulp file, существенно ускорили работу наших сборок , особенно последующих, что крайне важно. Использование Watchify дало наилучший результат, сократив время с 3с до 200мс. Кэширование файлов также сэкономило нам несколько сотен миллисекунд в таске hint. Мы разделили тестовые и рабочие задачи, что позволило совершать только те операции, которые необходимы в данный момент. Это позволит добавлять source maps, отлаживать hints в тестовой сборке, и минифицировать всё — в рабочей.</p>
<p>Для сравнения, <a href="https://github.com/mlms13/build-optimizations/blob/master/Gulpfile.js" target="_blank" rel="external">вот</a>  наш первоначальный Gulpfile, собирающий и пересобирающий всё в течение 4 секунд. А вот наш <a href="https://github.com/mlms13/build-optimizations/blob/incremental/Gulpfile.js" target="_blank" rel="external">оптимизированный Gulpfile</a>, с более высокой скоростью сборки и пересборкой в 10 раз быстрее.  </p>
<p>###Подождите, а как же… Broccoli?</p>
<p>Broccoli – новый инструмент для сборки проектов, с акцентом на улучшенные пересборки. Если вы внимательно прочитаете пост о <a href="http://www.solitr.com/blog/2014/02/broccoli-first-release/" target="_blank" rel="external">первом релизе Broccoli</a>,  заметите, что этот таск-менеджер создавался для решения проблем, со многими из которых мы боролись выше. </p>
<p>«Broccoli serve автоматически определяет, какие файлы отслеживать (watch) и пересобирает только те, которые того требуют. Наша цель — менее 200мс на пересборку с типичным стеком сборки».</p>
<p>Звучит отлично, с одной оговоркой. <a href="https://github.com/gingerhendrix/broccoli-browserify/issues/10" target="_blank" rel="external">Поддерживаемый сообществом плагин Browserify для Broccoli</a> не работает с Watchify. Способность Broccoli “пересобирать только те файлы, которые того требуют” не применима в контексте полноценной Browserify сборки. Поскольку Browserify с самого начала был нашей основной головной болью, отсутствие Watchify делает Broccoli не привлекательным вариантом на данный момент.</p>
<p>####А как насчёт предварительной обработки CSS?</p>
<p>Признаюсь, об этой теме мы немного умолчали. Рекомендованные Gulp инструменты для последующих сборок, такие как gulp-cached, не сильно нам помогут в тех случаях, когда нужно обрабатывать большое количество входных файлов, объединяя их в один конечный файл. Для последующих CSS сборок понадобится специальный инструмент, делающий примерно то же, что Watchify для Browserify, и подобные инструменты для Stylus мне не известны.</p>
<p>В Pellucid, компиляция более, чем 300 Stylus файлов, содержащих более 2300 селекторов, занимает 2-3 секунды. Изменения в файлы стилей вносятся не так часто, как в javascript файлы, поэтому это допустимые показатели.</p>
<p>Я наслышан ужастиков о компиляции Ruby Sass, занимающей 20-30 и более секунд. В этом случае вам стоит задуматься о переходе на port C в Sass, который в разы быстрее. Вот отличная <a href="http://blog.teamtreehouse.com/tale-front-end-sanity-beware-sass-import" target="_blank" rel="external">статья в блоге Treehouse</a>, в которой они рассказали, как сократили время Sass-сборки с 50 до 3 секунд.</p>
<p>####Что ещё можно автоматизировать?</p>
<p>Существует немало способов атвоматизации сборок, что, несомненно, ускоряет рабочий процесс. Существует множество разнообразных способов настраивания вашего Gulp File: от популярных, таких как <a href="https://github.com/vohof/gulp-livereload" target="_blank" rel="external">LiveReload</a> и <a href="https://github.com/sindresorhus/gulp-mocha" target="_blank" rel="external">автоматизированных тестов</a>, до более сложных — <a href="https://github.com/stevelacy/gulp-bump" target="_blank" rel="external">поднятие пакетных версий</a> (gulp-bump) и <a href="https://gist.github.com/mlms13/4ed66cb920caf734ab1c" target="_blank" rel="external">развёртывание на Heroku</a>. </p>
<p>Надеюсь, в этой статье мы затронули самые наболевшие вопросы: типичные задачи, работающие с большим количеством файлов, запускаемые и перезапускаемые при каждом последующем пересохранении файлах. Если вы заметили, что ещё какие-то задачи замедляют вашу работу — и, особенно, если вы придумали, как эту проблему решить — обязательно поделитесь с нами в комментариях! </p>
<p>По мотивам Michael Martin-Smucker </p>
  </section> <footer class='post-footer clearfix'>   <div class="addthis_toolbox addthis_default_style pull-right"> <a class="addthis_button_facebook"></a> <a class="addthis_button_twitter"></a> <a class="addthis_button_vk"></a> <a class="addthis_button_compact"></a> <a class="addthis_counter addthis_bubble_style"></a></div><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>  </footer> </div></article><section id="comment"> <h3 class="title">Комментарии</h3> <div id="disqus_thread"> <noscript>Включите Javascript, чтобы просмотреть <a href="//disqus.com/?ref_noscript">комментарии с помощью Disqus.</a></noscript> </div></section></div> <aside class="span2">  <div class="widget tag"> <h3 class="title">Тэги</h3> <ul class="unstyled">  <li> <span class='badge'>31</span> <a href="/blog/tags/AngularJS/"> AngularJS </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/CSS/"> CSS </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Chef/"> Chef </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Coffee-script/"> Coffee-script </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Cordova/"> Cordova </a> </li>  <li> <span class='badge'>5</span> <a href="/blog/tags/ElasticSearch/"> ElasticSearch </a> </li>  <li> <span class='badge'>5</span> <a href="/blog/tags/FAQ/"> FAQ </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/GitHub/"> GitHub </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/HTML5/"> HTML5 </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/ItProjects/"> ItProjects </a> </li>  <li> <span class='badge'>29</span> <a href="/blog/tags/Javascript/"> Javascript </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Mongoose/"> Mongoose </a> </li>  <li> <span class='badge'>9</span> <a href="/blog/tags/Node-js/"> Node.js </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/NodeJS/"> NodeJS </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Objective-C/"> Objective-C </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/PhoneGap/"> PhoneGap </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/RabbitMQ/"> RabbitMQ </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/SEO/"> SEO </a> </li>  <li> <span class='badge'>3</span> <a href="/blog/tags/SQL/"> SQL </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/YAC2014/"> YAC2014 </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/bash/"> bash </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/iOS7/"> iOS7 </a> </li>  <li> <span class='badge'>2</span> <a href="/blog/tags/jQuery/"> jQuery </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Бизнес-модель/"> Бизнес модель </a> </li>  <li> <span class='badge'>4</span> <a href="/blog/tags/Для-новичков/"> Для новичков </a> </li>  <li> <span class='badge'>1</span> <a href="/blog/tags/Жизнь-компании/"> Жизнь компании </a> </li>  </ul></div></aside> </div></section> <!-- /container --><footer id='contacts' class='footer-main'> <div class='callback'> <div class='container'> <div class='row'> <div class='span12'> <h2 class='xlarge'>Есть вопросы или предложения?</h2> <p class='outlined-caption'>закажите обратный звонок и наш менеджер перезвонит вам</p> <form method='POST' action='/brief' id='callback'> <ul class='hidden error'></ul> <input type="text" name='name' placeholder="Как к вам обратиться?" class='span12' required /> <input type="text" name='phone' placeholder="По какому номеру звонить?" class='span6' /> <input type="email" name='email' placeholder="E-mail (опционально)" class='span6 pull-right' /> <textarea name='question' placeholder="Ваш вопрос (опционально)" class='span12'></textarea> <button type="submit" class='blue-plank'>Заказать звонок</button> </form> </div> </div> </div> </div> <div class='container'> <div class='row'> <div class='span6'> <h4 class='footer-caption'>Разделы сайта</h4> <ul class="nav inline">  <li><a href="/blog">Блог</a></li>  <li><a href="/team">Команда</a></li>  <li><a href="#about">О нас</a></li>  <li><a href="#portfolio">Портфолио</a></li>  <li><a href="#tech">Технологии</a></li>  <li><a href="#contacts">Контакты</a></li>  <li><a href='https://github.com/AVVSDevelopment/avvs.co'>Проект на GitHub</a></li> </ul> <p class='copyright'>Makeomatic, (c) 2012-2014<br/>Разработка сайтов и мобильных приложений</p> </div> <div class='span6 blue-line'> <h4 class='footer-caption'>Контакты</h4> <p> тел: +7 (495) 79-222-44 </p> <p> e-mail: <a href="mailto:getstarted@makeomatic.ru">getstarted@makeomatic.ru</a> </p> <address> Россия, Москва, Ленинский пр-т, дом 30а<br/>индекс: 111555 </address> <div class="social"> <a class="fcb fa-stack fa-lg" href="https://www.facebook.com/makeomatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i> </a> <a class="fa-stack fa-lg" href="http://vk.com/makeomatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-vk fa-stack-1x fa-inverse"></i> </a> <a class="twt fa-stack fa-lg" href="https://twitter.com/MakeOmatic"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </a> <a class="gp fa-stack fa-lg" href="https://google.com/+MakeomaticRu"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i> </a> </div> </div> </div> </div></footer><div class="modal hide fade brief" id='brief'> <div class="modal-body"> <div class='text-center'> <h2 class='brief-header outlined-caption'>Расскажите нам о вашем проекте</h2> <p class='small'> Коротко опишите ваши идеи или просто прикрепите файл с готовым ТЗ.<br/> Мы свяжемся с вами в течение 1 дня и подробно расскажем о том, как мы можем вам помочь. </p> </div> <form method='POST' action='/brief' class='callback'> <input type="text" name='name' placeholder="Как к вам обратиться?" class='span10' required /> <input type="text" name='phone' placeholder="По какому номеру звонить?" class='span5' /> <input type="email" name='email' placeholder="E-mail (опционально)" class='span5 pull-right' /> <textarea name='question' placeholder="Краткое описание вашего проекта" class='span7'></textarea> <div class='dropbox pull-right' id='dropbox' ></div> <button class="blue-plank pull-right" type='submit'>Отправить</button> </form> </div></div><!-- scripts --><script src="/js/app.min.2.1.0.js" charset="UTF-8" ></script><!-- end scripts --><script type="text/javascript">var disqus_shortname = 'makeomatic';(function(){ var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);}());</script><!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter15629977 = new Ya.Metrika({id:15629977, webvisor:true, clickmap:true, trackLinks:true, accurateTrackBounce:true, trackHash:true, ut:"noindex"}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/15629977?ut=noindex" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter --><!-- google analytics --><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-40638966-1', 'makeomatic.ru'); ga('send', 'pageview');</script></body></html>